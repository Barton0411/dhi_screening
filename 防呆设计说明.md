# 🔧 防呆设计说明

## 问题背景
用户可能在"显示设置"中意外将字体颜色设置为白色或浅色，导致在白色背景上文字看不见，特别是"慢性乳房炎筛查"和"隐形乳房炎监测"等界面文字消失。

## 解决方案

### 1. 🔍 自动颜色修正
**文件**: `desktop_app.py` - `validate_and_fix_font_color()` 方法

**功能**: 
- 启动时自动检查字体颜色亮度
- 如果亮度 > 90%，自动修正为黑色 (#000000)
- 同时更新QSettings避免重复触发
- 控制台输出修正提醒

**代码逻辑**:
```python
brightness = (r * 0.299 + g * 0.587 + b * 0.114) / 255
if brightness > 0.9:
    print(f"⚠️ 防呆提醒：检测到过浅的字体颜色 {color_str}（亮度{brightness:.1%}），已自动修正为黑色")
    self.settings.setValue("font_color", "#000000")
    return "#000000"
```

### 2. 🚨 启动时智能提醒  
**文件**: `desktop_app.py` - `check_display_issues_on_startup()` 方法

**功能**:
- 程序启动1秒后自动检查显示设置
- 检测浅色字体(亮度>85%) + 白色背景的组合
- 弹出友好的提醒对话框
- 提供一键恢复默认设置选项

**触发条件**:
- 字体亮度 > 85%
- 背景颜色为白色系 (#ffffff, #fff, white)

### 3. ⚠️ 颜色选择时实时保护
**文件**: `desktop_app.py` - `choose_font_color()` 方法

**功能**:
- 在显示设置对话框中选择字体颜色时
- 实时检测选择的颜色亮度
- 如果亮度 > 90%，弹出确认对话框
- 说明可能的可读性问题
- 允许用户确认或取消选择

**用户体验**:
```
⚠️ 您选择的颜色 #f0f0f0 过于浅淡（亮度91.8%）！

在白色背景上可能看不清文字。

建议选择深色字体以确保良好的可读性。

是否仍要使用这个颜色？
```

### 4. 🔧 一键恢复菜单
**文件**: `desktop_app.py` - `reset_display_settings_to_default()` 方法

**位置**: 菜单栏 → 设置 → 🔧 恢复默认显示

**功能**:
- 一键恢复所有显示设置为安全默认值
- 详细的确认对话框说明将要恢复的设置
- 立即应用，无需重启程序
- 成功后显示确认消息

**恢复的设置**:
- 字体颜色：黑色 (#000000)
- 背景颜色：白色 (#ffffff)
- 字体类型：Microsoft YaHei
- 字体大小：12px
- 显示比例：100%
- 字体样式：取消加粗/斜体/下划线
- 跟随系统主题：启用

## 技术实现

### 亮度计算公式
使用相对亮度公式（基于人眼感知）：
```python
brightness = (r * 0.299 + g * 0.587 + b * 0.114) / 255
```

### 阈值设计
- **自动修正阈值**: 90% (0.9) - 极度严格，防止任何可能的可见性问题
- **启动提醒阈值**: 85% (0.85) - 较宽松，给用户选择权
- **选择提醒阈值**: 90% (0.9) - 严格但允许用户坚持选择

### 执行时机
1. **程序启动时**: `validate_and_fix_font_color()` 立即执行
2. **启动1秒后**: `check_display_issues_on_startup()` 友好提醒
3. **颜色选择时**: `choose_font_color()` 实时检查
4. **用户主动**: 菜单中的恢复选项随时可用

## 用户操作流程

### 自动恢复流程
1. 程序启动
2. 自动检测到白色字体
3. 静默修正为黑色
4. 控制台输出提醒信息
5. 界面正常显示

### 手动恢复流程  
1. 菜单栏 → 设置 → 🔧 恢复默认显示
2. 阅读详细说明对话框
3. 点击"是"确认恢复
4. 立即看到设置生效
5. 收到成功确认消息

## 防呆效果

### 完全防护
- ❌ 用户无法设置完全看不见的字体
- ❌ 启动时发现问题会主动提醒
- ❌ 选择过浅颜色时会警告
- ✅ 提供简单的恢复方案

### 用户友好
- 🎯 不强制阻止用户选择，提供确认机会
- 💡 提供清晰的问题说明和解决方案
- 🔧 一键恢复功能随时可用
- 📱 所有提醒都包含emoji增强可读性

## 测试场景

### 测试用例1: 极浅颜色自动修正
1. 手动设置字体颜色为 #fefefe
2. 重启程序
3. 验证字体自动变为黑色
4. 检查控制台是否有修正提醒

### 测试用例2: 启动时智能提醒
1. 设置字体颜色为 #e0e0e0 (亮度87%)
2. 设置背景为白色
3. 重启程序
4. 验证1秒后是否弹出提醒对话框

### 测试用例3: 选择时实时保护
1. 打开显示设置对话框
2. 点击字体颜色选择
3. 选择很浅的颜色如 #f5f5f5
4. 验证是否弹出警告对话框

### 测试用例4: 一键恢复功能
1. 故意设置问题配置
2. 菜单 → 设置 → 恢复默认显示
3. 确认恢复操作
4. 验证所有设置是否正确恢复

## 维护说明

### 调整阈值
如需调整亮度检测阈值，修改以下常量：
- 自动修正: `brightness > 0.9` 
- 启动提醒: `brightness > 0.85`
- 选择警告: `brightness > 0.9`

### 扩展功能
可以考虑添加：
- 背景颜色亮度检查（防止过深背景）
- 颜色对比度检查（背景与字体的对比度）
- 用户偏好记忆（记住用户的选择倾向）
- 多语言支持（国际化友好提示）

---

> 💡 **设计理念**: "智能防护 + 用户自主" - 既要防止用户犯错，又要尊重用户的选择权，在易用性和灵活性之间找到完美平衡。 