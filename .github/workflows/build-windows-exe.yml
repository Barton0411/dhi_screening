name: Build Windows EXE and Installer

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-windows-exe:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install -r requirements.txt
    
    - name: Build EXE with PyInstaller
      run: |
        pyinstaller --clean --noconfirm "DHI_Screening_System_v3.0.spec"
    
    - name: Install Inno Setup
      run: |
        # ä¸‹è½½å¹¶å®‰è£…Inno Setup
        $url = "https://jrsoftware.org/download.php/is.exe"
        $output = "innosetup-installer.exe"
        Invoke-WebRequest -Uri "https://files.jrsoftware.org/is/6/innosetup-6.2.2.exe" -OutFile $output
        Start-Process -FilePath $output -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART" -Wait
        # æ·»åŠ Inno Setupåˆ°PATH
        $env:PATH += ";C:\Program Files (x86)\Inno Setup 6"
        echo "C:\Program Files (x86)\Inno Setup 6" >> $env:GITHUB_PATH
        
    - name: Verify Inno Setup installation
      run: |
        $innoPath = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
        if (Test-Path $innoPath) {
          Write-Host "âœ… Inno Setupå®‰è£…æˆåŠŸ"
          Write-Host "ISCC.exeè·¯å¾„: $innoPath"
        } else {
          Write-Host "âŒ Inno Setupå®‰è£…å¤±è´¥"
          exit 1
        }
        
    - name: Check required files
      run: |
        Write-Host "æ£€æŸ¥å¿…è¦æ–‡ä»¶æ˜¯å¦å­˜åœ¨:"
        $requiredFiles = @(
          "DHI_Screening_System_v3.0_Setup.iss",
          "LICENSE.txt", 
          "whg3r-qi1nv-001.ico",
          "README.md",
          "DHI_ç²¾å‡†ç­›æŸ¥åŠ©æ‰‹-æ“ä½œè¯´æ˜.md",
          "éœ€æ±‚è¯´æ˜.md",
          "config.yaml",
          "rules.yaml"
        )
        
        foreach ($file in $requiredFiles) {
          if (Test-Path $file) {
            Write-Host "âœ… $file å­˜åœ¨"
          } else {
            Write-Host "âŒ $file ä¸å­˜åœ¨"
          }
        }
        
        Write-Host "`næ£€æŸ¥PyInstallerè¾“å‡ºç›®å½•:"
        if (Test-Path "dist\DHI_Screening_System_v3.0") {
          Write-Host "âœ… dist\DHI_Screening_System_v3.0 å­˜åœ¨"
          $fileCount = (Get-ChildItem "dist\DHI_Screening_System_v3.0" -Recurse).Count
          Write-Host "   åŒ…å« $fileCount ä¸ªæ–‡ä»¶"
        } else {
          Write-Host "âŒ dist\DHI_Screening_System_v3.0 ä¸å­˜åœ¨"
          exit 1
        }
        
    - name: Create installer with Inno Setup
      run: |
        # åˆ›å»ºinstallerç›®å½•
        if (-not (Test-Path "installer")) {
          New-Item -ItemType Directory -Path "installer"
        }
        # ç¼–è¯‘å®‰è£…è„šæœ¬
        $isccPath = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
        Write-Host "å¼€å§‹ç¼–è¯‘å®‰è£…è„šæœ¬..."
        Write-Host "è„šæœ¬æ–‡ä»¶: DHI_Screening_System_v3.0_Setup.iss"
        Write-Host "å·¥ä½œç›®å½•: $(Get-Location)"
        & $isccPath "DHI_Screening_System_v3.0_Setup.iss"
        if ($LASTEXITCODE -eq 0) {
          Write-Host "âœ… å®‰è£…è„šæœ¬ç¼–è¯‘æˆåŠŸ"
        } else {
          Write-Host "âŒ å®‰è£…è„šæœ¬ç¼–è¯‘å¤±è´¥ï¼Œé€€å‡ºä»£ç : $LASTEXITCODE"
          exit 1
        }
        
    - name: Verify installer creation
      run: |
        $installerPath = "installer\DHI_Screening_System_v3.0_Setup.exe"
        if (Test-Path $installerPath) {
          $fileSize = (Get-Item $installerPath).Length / 1MB
          Write-Host "âœ… å®‰è£…åŒ…ç”ŸæˆæˆåŠŸ: $([math]::Round($fileSize, 2)) MB"
          Write-Host "ğŸ“ å®‰è£…åŒ…è·¯å¾„: $installerPath"
        } else {
          Write-Host "âŒ å®‰è£…åŒ…ç”Ÿæˆå¤±è´¥"
          Write-Host "ğŸ“ installerç›®å½•å†…å®¹:"
          Get-ChildItem installer -ErrorAction SilentlyContinue
          exit 1
        }
    
    - name: Create release package (Portable)
      run: |
        mkdir release
        xcopy "dist\DHI_Screening_System_v3.0" "release\DHI_Screening_System_v3.0" /E /I
        xcopy "README.md" "release\" /Y
        xcopy "DHI_ç²¾å‡†ç­›æŸ¥åŠ©æ‰‹-æ“ä½œè¯´æ˜.md" "release\" /Y
        xcopy "LICENSE.txt" "release\" /Y
        
    - name: Upload Portable Version
      uses: actions/upload-artifact@v4
      with:
        name: DHI_Screening_System_v3.0_Portable
        path: release/
        
    - name: Upload Windows Installer
      uses: actions/upload-artifact@v4
      with:
        name: DHI_Screening_System_v3.0_Installer
        path: installer/
        
    - name: Compress portable for release
      run: |
        powershell Compress-Archive -Path "release\*" -DestinationPath "DHI_Screening_System_v3.0_Portable.zip"
        
    - name: Upload Portable ZIP
      uses: actions/upload-artifact@v4
      with:
        name: DHI_Screening_System_v3.0_Portable_ZIP
        path: DHI_Screening_System_v3.0_Portable.zip
        
    - name: Create release info
      run: |
        $content = "# DHIç­›æŸ¥åˆ†æç³»ç»Ÿ v3.0 æ„å»ºä¿¡æ¯`n`n"
        $content += "## å¼€å‘å•ä½`nä¼Šåˆ©æ¶²å¥¶å¥¶ç§‘é™¢`n`n"
        $content += "## æ„å»ºäº§ç‰©`n"
        $content += "1. å®‰è£…åŒ…ç‰ˆæœ¬: DHI_Screening_System_v3.0_Setup.exe`n"
        $content += "   - ä¸“ä¸šWindowså®‰è£…ç¨‹åº`n"
        $content += "   - æ”¯æŒå¼€å§‹èœå•ã€æ¡Œé¢å¿«æ·æ–¹å¼`n"
        $content += "   - åŒ…å«å®Œæ•´çš„å¸è½½åŠŸèƒ½`n"
        $content += "   - æ¨èç”¨äºç”Ÿäº§ç¯å¢ƒ`n`n"
        $content += "2. ä¾¿æºç‰ˆæœ¬: DHI_Screening_System_v3.0_Portable.zip`n"
        $content += "   - å…å®‰è£…ç»¿è‰²ç‰ˆæœ¬`n"
        $content += "   - è§£å‹å³ç”¨ï¼Œæ— éœ€ç®¡ç†å‘˜æƒé™`n"
        $content += "   - é€‚åˆä¸´æ—¶ä½¿ç”¨æˆ–æµ‹è¯•`n`n"
        $content += "## ç³»ç»Ÿè¦æ±‚`n"
        $content += "- Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬ (64ä½)`n"
        $content += "- 4GB RAM (æ¨è8GB)`n"
        $content += "- 500MB å¯ç”¨ç£ç›˜ç©ºé—´`n`n"
        $content += "## ä¸»è¦åŠŸèƒ½`n"
        $content += "- DHIæ•°æ®ç­›é€‰åˆ†æ`n"
        $content += "- éšå½¢ä¹³æˆ¿ç‚ç›‘æµ‹`n"
        $content += "- æ…¢æ€§ä¹³æˆ¿ç‚ç­›æŸ¥`n"
        $content += "- ç‰›ç¾¤å¥åº·ç®¡ç†`n`n"
        $content += "## å®‰è£…è¯´æ˜`n"
        $content += "### å®‰è£…åŒ…ç‰ˆæœ¬`n"
        $content += "1. ä¸‹è½½ DHI_Screening_System_v3.0_Setup.exe`n"
        $content += "2. ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œå®‰è£…ç¨‹åº`n"
        $content += "3. æŒ‰ç…§å®‰è£…å‘å¯¼å®Œæˆå®‰è£…`n"
        $content += "4. ä»å¼€å§‹èœå•å¯åŠ¨ç¨‹åº`n`n"
        $content += "### ä¾¿æºç‰ˆæœ¬`n"
        $content += "1. ä¸‹è½½ DHI_Screening_System_v3.0_Portable.zip`n"
        $content += "2. è§£å‹åˆ°ä»»æ„ç›®å½•`n"
        $content += "3. è¿è¡Œ DHI_Screening_System_v3.0.exe`n`n"
        $content += "æ„å»ºæ—¶é—´: $(Get-Date)`n"
        $content += "æ„å»ºç‰ˆæœ¬: GitHub Actions è‡ªåŠ¨æ„å»º"
        $content | Out-File -FilePath "æ„å»ºè¯´æ˜.txt" -Encoding UTF8
        
    - name: Upload release info
      uses: actions/upload-artifact@v4
      with:
        name: Build_Info
        path: æ„å»ºè¯´æ˜.txt 