name: Build Windows EXE (OneDIR Mode)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows-exe:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        architecture: 'x64'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install -r requirements.txt
        Write-Host "âœ… ä¾èµ–å®‰è£…æˆåŠŸ"
    
    - name: Build EXE with PyInstaller OneDIR Mode
      run: |
        Write-Host "ï¿½ï¿½ å¼€å§‹æ„å»ºWindowså¯æ‰§è¡Œæ–‡ä»¶ (OneDIRæ¨¡å¼)..."
        Write-Host "ğŸ“‹ ä½¿ç”¨é…ç½®æ–‡ä»¶: DHI_Screening_System_v3.3.spec"
        Write-Host "ğŸš€ OneDIRæ¨¡å¼ä¼˜åŠ¿: å¯åŠ¨é€Ÿåº¦å¿«ï¼Œæ–‡ä»¶ç»“æ„æ¸…æ™°"
        
        pyinstaller --clean --noconfirm "DHI_Screening_System_v3.3.spec"
        
        $distDir = "dist\DHI_Screening_System_v3.3"
        $exePath = "$distDir\DHI_Screening_System_v3.3.exe"
        
        if (Test-Path $exePath) {
          $fileSize = (Get-Item $exePath).Length / 1MB
          Write-Host "âœ… EXEæ„å»ºæˆåŠŸ: $([math]::Round($fileSize, 2)) MB"
          
          Write-Host "ğŸ“‚ OneDIRæ„å»ºç»“æœ:"
          Get-ChildItem $distDir | Format-Table Name, Length, LastWriteTime
          
          $totalSize = (Get-ChildItem $distDir -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
          Write-Host "ğŸ“Š å®Œæ•´åº”ç”¨å¤§å°: $([math]::Round($totalSize, 2)) MB"
          
          $fileCount = (Get-ChildItem $distDir -Recurse -File).Count
          Write-Host "ğŸ“„ æ–‡ä»¶æ€»æ•°: $fileCount"
          
        } else {
          Write-Host "âŒ EXEæ„å»ºå¤±è´¥"
          exit 1
        }
    
    - name: Create distribution package
      run: |
        Write-Host "ğŸ“¦ åˆ›å»ºåˆ†å‘åŒ…..."
        
        $packageDir = "DHI_Release_Package"
        if (Test-Path $packageDir) {
          Remove-Item -Recurse -Force $packageDir
        }
        New-Item -ItemType Directory -Path $packageDir
        
        $sourceDir = "dist\DHI_Screening_System_v3.3"
        $targetDir = "$packageDir\DHI_Screening_System_v3.3"
        
        Copy-Item -Path $sourceDir -Destination $targetDir -Recurse
        Write-Host "âœ… OneDIRåº”ç”¨å·²å¤åˆ¶åˆ°åˆ†å‘åŒ…"
        
        $docFiles = @("README.md", "LICENSE.txt", "CHANGELOG.md", "whg3r-qi1nv-001.ico")
        foreach ($file in $docFiles) {
          if (Test-Path $file) {
            Copy-Item -Path $file -Destination $packageDir
            Write-Host "âœ… å·²å¤åˆ¶: $file"
          }
        }
        
        $buildTime = Get-Date -Format 'yyyy-MM-dd HH:mm:ss'
        $usageInfo = "DHIç²¾å‡†ç­›æŸ¥åŠ©æ‰‹ v3.3 - OneDIRç‰ˆæœ¬`n`n=== æ„å»ºä¿¡æ¯ ===`næ„å»ºæ—¶é—´: $buildTime`næ„å»ºæ–¹å¼: PyInstaller OneDIR Mode`nç³»ç»Ÿæ¶æ„: Windows x64`nPythonç‰ˆæœ¬: 3.11`n`n=== ä½¿ç”¨è¯´æ˜ ===`n1. è§£å‹æ•´ä¸ªæ–‡ä»¶å¤¹åˆ°ç›®æ ‡ä½ç½®`n2. è¿›å…¥ DHI_Screening_System_v3.3 ç›®å½•`n3. åŒå‡»è¿è¡Œ DHI_Screening_System_v3.3.exe`n`n=== OneDIRæ¨¡å¼ä¼˜åŠ¿ ===`nâœ… å¯åŠ¨é€Ÿåº¦å¿« (2-3ç§’)`nâœ… æ–‡ä»¶ç»“æ„æ¸…æ™°`nâœ… ä¾èµ–åº“ç‹¬ç«‹å­˜æ”¾`nâœ… ä¾¿äºè°ƒè¯•å’Œç»´æŠ¤`nâœ… æ”¯æŒå¢é‡æ›´æ–°`n`n=== ç³»ç»Ÿè¦æ±‚ ===`n- Windows 7/8/10/11 (64ä½)`n- å†…å­˜: 4GB RAM æ¨è`n- ç¡¬ç›˜: 200MB å¯ç”¨ç©ºé—´`n`næŠ€æœ¯æ”¯æŒ: ä¼Šåˆ©æ¶²å¥¶å¥¶ç§‘é™¢"
        
        $usageInfo | Out-File -FilePath "$packageDir\ä½¿ç”¨è¯´æ˜.txt" -Encoding UTF8
        
        $shortcutScript = '@echo off' + "`n" + 'echo æ­£åœ¨åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼...' + "`n" + 'set "target=%~dp0DHI_Screening_System_v3.3\DHI_Screening_System_v3.3.exe"' + "`n" + 'set "shortcut=%USERPROFILE%\Desktop\DHIç²¾å‡†ç­›æŸ¥åŠ©æ‰‹.lnk"' + "`n" + 'powershell -Command "& {$WshShell = New-Object -comObject WScript.Shell; $Shortcut = $WshShell.CreateShortcut(''%shortcut%''); $Shortcut.TargetPath = ''%target%''; $Shortcut.WorkingDirectory = ''%~dp0DHI_Screening_System_v3.3''; $Shortcut.IconLocation = ''%~dp0whg3r-qi1nv-001.ico''; $Shortcut.Save()}"' + "`n" + 'if exist "%shortcut%" (' + "`n" + '    echo âœ… æ¡Œé¢å¿«æ·æ–¹å¼åˆ›å»ºæˆåŠŸï¼' + "`n" + ') else (' + "`n" + '    echo âŒ å¿«æ·æ–¹å¼åˆ›å»ºå¤±è´¥' + "`n" + ')' + "`n" + 'pause'
        
        $shortcutScript | Out-File -FilePath "$packageDir\åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼.bat" -Encoding UTF8
        
        Write-Host "ğŸ“‹ åˆ†å‘åŒ…å†…å®¹:"
        Get-ChildItem $packageDir | Format-Table Name, Length, LastWriteTime
        
        $packageSize = (Get-ChildItem $packageDir -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
        Write-Host "ğŸ“Š åˆ†å‘åŒ…æ€»å¤§å°: $([math]::Round($packageSize, 2)) MB"
    
    - name: Create ZIP archive
      run: |
        Write-Host "ğŸ—œï¸ åˆ›å»ºZIPå‹ç¼©åŒ…..."
        
        $zipName = "DHI_Screening_System_v3.3_OneDIR_$(Get-Date -Format 'yyyyMMdd_HHmmss').zip"
        
        Compress-Archive -Path "DHI_Release_Package\*" -DestinationPath $zipName -CompressionLevel Optimal
        
        if (Test-Path $zipName) {
          $zipSize = (Get-Item $zipName).Length / 1MB
          Write-Host "âœ… ZIPå‹ç¼©åŒ…åˆ›å»ºæˆåŠŸ: $([math]::Round($zipSize, 2)) MB"
          Write-Host "ğŸ“¦ æ–‡ä»¶å: $zipName"
        } else {
          Write-Host "âŒ ZIPå‹ç¼©åŒ…åˆ›å»ºå¤±è´¥"
          exit 1
        }
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: DHI-OneDIR-v3.3-${{ github.run_number }}
        path: |
          DHI_Screening_System_v3.3_OneDIR_*.zip
          DHI_Release_Package/
        retention-days: 30
    
    - name: Build summary
      run: |
        Write-Host "ğŸ‰ OneDIRæ„å»ºå®Œæˆæ‘˜è¦"
        Write-Host "========================"
        Write-Host "ï¿½ï¿½ ç‰ˆæœ¬: v3.3"
        Write-Host "ğŸ”§ æ¨¡å¼: PyInstaller OneDIR"
        Write-Host "ğŸš€ å¯åŠ¨é€Ÿåº¦: å¿«é€Ÿ (2-3ç§’)"
        Write-Host "ğŸ“‚ è¾“å‡º: DHI_Screening_System_v3.3/ ç›®å½•"
        Write-Host "ğŸ’¾ ä¸‹è½½: GitHub Actions Artifacts"
        Write-Host "ğŸ“‹ åŒ…å«: å®Œæ•´åº”ç”¨ + ä½¿ç”¨è¯´æ˜ + å¿«æ·æ–¹å¼è„šæœ¬"
        Write-Host "ğŸ–¥ï¸ å…¼å®¹: Windows 7/8/10/11 (64ä½)"
        Write-Host ""
        Write-Host "âœ… ç”¨æˆ·å¯ä»¥ä¸‹è½½ZIPåŒ…ï¼Œè§£å‹åç›´æ¥ä½¿ç”¨"
        Write-Host "âœ… æ”¯æŒç”¨Inno Setupåˆ¶ä½œä¸“ä¸šå®‰è£…åŒ…"
