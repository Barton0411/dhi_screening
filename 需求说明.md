# 需求说明

## 1. 项目背景
本工具用于对奶牛 DHI 报告中的 **04-2 综合测定结果表** 进行批量筛查与统计，支持用户直接上传压缩包或表格文件，通过自定义区间与指标进行过滤后，导出符合条件的结果表。

## 2. 输入数据
1. **压缩包 ZIP**：命名格式 `151537(YYYY-MM)牛场名称.zip`，内部包含 `04-2综合测定结果表.xlsx`。
2. **单独 Excel**：亦可直接上传 `04-2综合测定结果表.xlsx`。
3. 文件编码：UTF-8 / Excel 2007+ (`.xlsx`)。

## 3. 表头字段
| 中文列名 | 英文字段 | 说明 |
| -------- | -------- | ---- |
| 序号 | index | 自增序号 |
| 牛场编号 | farm_id | 牛场唯一编号 |
| 管理号 | cow_id | 单牛唯一编号 |
| 胎次(胎) | parity | 当前胎次 |
| 采样日期 | sample_date | DHI 采样日期 |
| 产犊日期 | calving_date | 最近一次产犊日 |
| 产犊间隔(天) | calving_interval | 两次产犊间隔 |
| 泌乳天数(天) | lactation_days | 本泌乳期天数 |
| 分组号 | group_no | 牧场内部分组 |
| 产奶量(Kg) | milk_yield | 本次采样产奶量 |
| 乳脂率(%) | fat_pct | 本次乳脂率 |
| 蛋白率(%) | protein_pct | 本次蛋白率 |
| … | … | 其余字段见 rules.yaml |

> **完整映射** 见 `rules.yaml` `field_map`。

## 4. 功能需求
1. **文件上传**
   * 支持单文件或批量压缩包上传。
   * 系统自动解析文件名中的 `(YYYY-MM)` 作为月份，若失败则提示用户输入。
2. **数据解析**
   * 自动解压并定位 `04-2综合测定结果表.xlsx`。
   * 按 `field_map` 将中文列名统一转换为英文字段名。
3. **筛查过滤**
   * **必选过滤项**：日期区间（sample_date）、牛场编号（farm_id）、胎次（parity）、蛋白率（protein_pct）必须始终启用。
   * **可选过滤项**：其余字段（如乳脂率、产奶量、体细胞数等）由用户在界面勾选启用；启用后其配置（min/max/列表）写回 `rules.yaml`。
   * 前端渲染规则：读取 `filters` 中 `required` 标记或 `enabled` 状态，动态生成表单。
4. **结果导出**
   * 生成 `筛选结果表_{日期}.xlsx`，包含：牛场编号、管理号、胎次及按月份展开的蛋白率/乳脂率/产奶量明细。
   * 支持多级表头或列展开。
5. **错误提示**
   * 表头缺失或不匹配 → 返回缺失字段列表。
   * 未找到目标 Excel → 提示检查压缩包。

## 5. 非功能需求
* Web API 基于 FastAPI，接口返回 JSON。
* 大文件上传限制 100 MB；使用临时目录做解压，完成后删除。
* 代码需配套单元测试，覆盖率 ≥ 80 %。

## 6. 配置文件
| 文件 | 作用 |
| ---- | ---- |
| `rules.yaml` | 业务规则与字段映射（本项目核心） |
| `config.yaml` | 通用配置：上传大小、缓存路径、默认过滤值 |
| `requirements.txt` | Python 依赖列表 |
| `.env` | 环境变量（数据库、日志级别） |

---
_last updated: 2025-06-05_