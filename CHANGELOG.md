# DHI精准筛查助手 - 版本更新日志

本文档记录了DHI精准筛查助手的所有版本历史和重要更新。

---

## [v4.01] - 2025-07-19

### 🚀 全面用户体验升级 ⭐

#### 新增功能
- **流畅进度条系统**
  - 所有耗时操作（上传、分析、筛查等）添加进度显示
  - 智能估算剩余时间，采用移动平均算法
  - 60 FPS 流畅动画效果
  - 支持取消操作确认对话框
  - 新增 `progress_manager.py` 模块统一管理

- **图表完全中文化**
  - PyQtGraph 图表右键菜单完全中文化
  - 支持视图、导出、网格、坐标轴等操作的中文显示
  - 新增 `chart_localization.py` 模块处理本地化
  - 提升中文用户的操作便利性

- **用户信息增强**
  - 在界面显示当前用户的工号和姓名
  - 格式：工号 (姓名)
  - 在多处同步显示用户信息

#### 优化改进
- **响应式设计**
  - 尿素氮分析数据表根据窗口大小自适应
  - 智能列宽调整，支持水平和垂直滚动
  - 优化表格显示效果

- **慢性乳房炎筛查增强**
  - 文件上传和筛查过程添加进度条显示
  - 优化大文件处理性能
  - 提升用户操作体验

#### Bug 修复
- 修复基础筛选误触发尿素氮追踪的问题
- 修复筛选完成后弹出取消确认对话框的问题
- 修复进度对话框关闭时的信号处理问题
- 优化异步操作处理，提升应用响应性

#### 技术改进
- 新增进度管理和图表本地化模块
- 优化代码结构，提高可维护性
- 改进错误处理机制

**发布日期**: 2025-07-19  
**版本状态**: 稳定版 - 用户体验全面升级  
**提交哈希**: 待更新

---

## [v3.91] - 2025-07-18

### 新增功能
- **尿素氮追踪分析功能**
  - 支持按泌乳阶段分组分析
  - 生成趋势图表和详细报告
  - 异常值自动标记和筛选

### 优化改进
- UI界面全面优化
- 登录窗口体验改进
- 修复多项显示问题

---

## [v3.8] - 2024-12-19

### 🎨 标签页宽度优化和界面对齐修复 ⭐
- **标签页宽度优化**
  - 增大主标签页最小宽度从70px到200px，确保中文标签名称完整显示
  - 为次级标签页添加最小宽度设置（100px），防止标签名称被截断
  - 支持DPI自适应缩放，在不同分辨率下保持合适的标签宽度
  - 解决"基础数据"、"DHI基础筛选"、"慢性乳房炎筛查"、"隐性乳房炎监测"等标签显示不全的问题

- **界面对齐统一修复**
  - 修复文件标签名称显示不全的问题，支持文本换行和完整显示
  - 统一所有QFormLayout的对齐方式为左对齐
  - 修复"慢性感染牛识别标准"区域的居中对齐问题
  - 确保"基础数据"筛选条件和处置办法配置区域都左对齐
  - 提升界面的一致性和专业性

### 🔧 技术改进
- **DPI自适应优化**
  - 主标签页：`tab_min_width = max(int(200 * dpi_ratio * 0.6), 200)`
  - 次级标签页：`sub_tab_min_width = max(int(100 * dpi_ratio * 0.6), 80)`
  - 确保在不同DPI设置下标签宽度都足够显示中文文本

- **布局对齐标准化**
  - 统一设置`QFormLayout`的标签对齐方式为左对齐
  - 统一设置表单对齐方式为左对齐和顶部对齐
  - 确保所有配置区域的布局一致性

### 📋 测试验证
- **新增多个测试文件**
  - `test_tab_width_fix.py` - 验证标签页宽度调整效果
  - `test_alignment_simple.py` - 简单测试左对齐效果
  - `test_all_alignment_fix.py` - 全面测试所有区域左对齐修复
  - 提供详细的手动测试指导

### 🎯 用户体验提升
- **标签显示优化**
  - 所有标签名称现在都能完整显示，不再被截断
  - 标签页宽度自适应内容，提升视觉舒适度
  - 支持长中文标签名称的完整显示

- **界面一致性**
  - 统一所有配置区域的对齐方式
  - 提升界面的整体协调性和专业性
  - 改善用户操作的视觉体验

**发布日期**: 2024-12-19  
**版本状态**: 稳定版 - 标签页宽度优化和界面对齐修复  
**提交哈希**: 134c99b  

---

## [v3.7] - 2024-12-19

### 🎨 界面文本显示和对齐优化 ⭐
- **文件标签文本完整显示**
  - 修复文件标签名称被截断的问题
  - 添加文本换行支持（`setWordWrap(True)`）
  - 设置最小宽度确保文本有足够显示空间
  - 使用`QSizePolicy.Expanding`允许水平扩展
  - 提升长文件名的可读性和用户体验

- **处置办法配置区域左对齐**
  - 修复处置办法配置区域居中对齐的问题
  - 设置`QFormLayout`的标签对齐方式为左对齐
  - 设置表单对齐方式为左对齐和顶部对齐
  - 统一"基础数据"和处置办法配置的布局标准
  - 提升界面的一致性和专业性

### 🔧 技术改进
- **布局对齐标准化**
  - 统一所有配置区域的布局对齐方式
  - 确保标签和控件的一致性显示
  - 提升界面的整体协调性

- **文本显示优化**
  - 优化文件标签的文本显示逻辑
  - 支持长文件名的自动换行
  - 保持界面美观的同时确保信息完整

### 📋 测试验证
- **新增UI对齐修复测试**
  - 创建`test_ui_alignment_fix.py`测试文件
  - 验证文件标签文本完整显示功能
  - 验证处置办法配置区域左对齐效果
  - 提供手动测试指导

**发布日期**: 2024-12-19  
**版本状态**: 稳定版 - 界面文本显示和对齐优化  
**提交哈希**: 待更新  

---

## [v3.6] - 2024-12-19

### 🎨 界面高度统一优化 ⭐
- **按钮高度标准化**
  - 所有按钮统一使用32px最小高度
  - 移除冗余的`setMaximumHeight()`限制
  - 统一使用CSS样式控制，提高代码维护性
  - 影响范围：所有使用按钮样式的控件

- **输入框高度优化**
  - 输入框高度从32px调整为28px
  - 减少垂直内边距，提升空间利用率
  - 统一QSpinBox、QDateEdit、QComboBox等表单控件
  - 保持水平内边距，确保文字清晰可读

- **进度条高度调整**
  - 进度条高度从4px调整为6px
  - 提升进度显示的醒目度和可读性
  - 优化视觉效果，更加清晰可见

- **文件标签高度优化**
  - 文件标签高度从20px调整为24px
  - 提升文件名的可读性和清晰度
  - 优化标签内文字显示效果

- **拖放区域高度统一**
  - 拖放区域高度从25px调整为32px
  - 与按钮高度保持一致，界面更协调
  - 提升拖放操作的视觉反馈

### 🔧 技术改进
- **DPI自适应缩放**
  - 所有高度值通过`get_dpi_scaled_size()`方法进行缩放
  - 确保在不同分辨率屏幕上显示一致
  - 增强跨平台兼容性

- **CSS样式统一管理**
  - 按钮样式集中在`get_responsive_button_styles()`方法
  - 表单样式集中在`get_responsive_form_styles()`方法
  - 便于统一维护和修改

- **代码质量提升**
  - 移除冗余的高度限制代码
  - 统一样式管理方式
  - 提高代码的可维护性

### 📋 测试验证
- **创建高度优化测试工具**
  - 新增`test_height_optimization.py`测试文件
  - 包含按钮、输入框、进度条、文件标签、拖放区域测试
  - 验证各种界面元素的高度统一性

### 📚 文档完善
- **新增界面高度优化总结文档**
  - 详细记录优化前后的对比
  - 提供技术实现细节和兼容性说明
  - 包含后续优化建议

**发布日期**: 2024-12-19  
**版本状态**: 稳定版 - 界面高度优化  
**提交哈希**: 待更新  

---

## [v3.5] - 2025-07-16

### 🎨 UI优化和用户体验改进 ⭐
- **文字规范化和专业性提升**
  - 全局修正：隐形乳房炎 → 隐性乳房炎
  - 涉及所有相关文件和界面文本
  - 提升专业术语的准确性和一致性

### 🗑️ 界面清理和优化
- **删除无效操作按钮**
  - 移除隐性乳房炎监测中的无效"上传DHI数据"按钮
  - 避免用户操作混淆，简化界面流程
  - 优化按钮布局和间距

### 📏 布局响应式改进
- **文件上传区域优化**
  - 文件列表高度从100px调整为35px（一行高度）
  - 提升界面紧凑性和空间利用率
  - 减少不必要的空白区域

### 🔄 动态容器高度管理
- **筛选项框智能调整**
  - 根据添加的筛选项数量自动调整容器高度
  - 移除固定高度限制和滚动条
  - 新增`adjust_filters_container_height()`算法
  - 支持最多600px高度限制，避免过度拉伸

### 🔧 状态显示修复
- **DHI数据状态准确性提升**
  - 修复隐性乳房炎监测中的DHI数据状态显示
  - 现在基于基础数据标签页的实际上传状态
  - 避免状态显示不一致的问题
  - 提供更清晰的数据来源标识

### 💡 用户反馈全面响应
- **基于用户具体建议的5项核心改进**
  - 文字修正、按钮删除、高度调整
  - 动态宽度、状态修复
  - 显著提升用户使用体验和界面专业性

**发布日期**: 2025-07-16  
**版本状态**: 稳定版 - UI体验优化  
**提交哈希**: 0f36f08  

---

## [v3.4] - 2025-07-16

### 🚀 OneDIR模式构建优化 ⭐
- **专注PyInstaller OneDIR模式构建**
  - 确保使用onedir模式，避免onefile启动慢的问题
  - 构建输出为完整的应用目录结构
  - 启动速度优化到2-3秒
  - 文件结构清晰，便于调试和维护

### 📦 完整分发包生成
- **自动创建用户友好的分发包**
  - 包含完整的OneDIR应用目录
  - 自动生成详细的使用说明文档
  - 提供桌面快捷方式创建脚本
  - 复制所有必要的文档和资源文件

### 🔧 构建流程简化
- **移除复杂的安装包生成**
  - 专注于EXE构建，用户自行制作安装包
  - 简化GitHub Actions workflow
  - 提供ZIP压缩包便于分发
  - 增强构建过程的监控和日志

### 📋 用户体验改进
- **提供完整的部署解决方案**
  - 详细的构建信息和系统要求说明
  - 自动生成的快捷方式创建工具
  - 清晰的目录结构和使用指南
  - 支持GitHub Artifacts下载

**发布日期**: 2025-07-16  
**版本状态**: 稳定版 - OneDIR快速启动  
**提交哈希**: 待更新  

---

## [v3.3] - 2025-07-15

### 🔧 架构兼容性根本修复 ⭐
- **彻底解决Windows安装架构限制问题**
  - 修复主要构建workflow中的Inno Setup配置错误
  - 将ArchitecturesAllowed从'x64'改为'x86 x64'
  - 移除ArchitecturesInstallIn64BitMode限制
  - 确保安装包可在32位和64位Windows系统上正常安装
  - 升级到v3.3版本，包含所有架构兼容性修复

### 📋 建立构建规范体系
- **完善项目构建规则**
  - 在rules.yaml中详细记录架构兼容性问题和解决方案
  - 建立GitHub Actions构建规范和质量保证清单
  - 提供架构问题预防检查清单和验证步骤
  - 规范多架构安装包的命名和版本管理

### 🎯 用户体验改进
- **增强系统兼容性**
  - 32位Windows系统用户现在可正常安装x86版本
  - 64位Windows系统用户可选择任意版本
  - 提供清晰的系统架构选择指南
  - 改进安装包的错误提示和用户引导

### 🔬 技术改进
- **优化构建流程**
  - 改进PyInstaller spec文件的架构特定配置
  - 增强Inno Setup脚本的动态生成逻辑
  - 完善构建过程的错误处理和调试信息
  - 建立多架构构建的最佳实践

**发布日期**: 2025-07-15  
**版本状态**: 稳定版 - 架构兼容性修复  
**提交哈希**: 0ee4310  

---

## [v3.2] - 2025-07-15

### 🚀 多架构支持
- **新增多架构自动化构建**
  - 支持Windows x64和x86两种架构的安装包
  - 使用GitHub Actions自动构建和发布
  - 每个架构生成独立的安装程序
  
### ✨ 性状筛选优化  
- **更新性状列表**
  - 精确匹配实际需求的23个核心性状
  - 包含：乳脂率、脂蛋比、体细胞数/分、尿素氮、乳糖率等
  - 移除不需要的冗余性状项目

### 📊 加权平均功能扩展
- **新增多种加权平均计算**
  - 乳脂率加权平均：平均乳脂率(%)
  - 乳糖率加权平均：平均乳糖率(%) 
  - 蛋白率加权平均：平均蛋白率(%)
  - 统一计算公式：Σ(性状值×产奶量) / Σ(产奶量)

### 🔧 技术改进
- **GitHub Actions自动化**
  - 支持推送时自动构建
  - 创建Git标签时自动发布
  - 支持手动触发构建
  - 多架构并行构建提高效率

### 🐛 架构兼容性修复
- **修复Windows架构安装限制问题**
  - 问题：x86安装包错误显示"只能安装在x64架构"
  - 原因：Inno Setup架构配置错误
  - 修复：正确配置x86版本的ArchitecturesAllowed设置
  - 结果：x86版本可在32位和64位系统上安装

### 📦 安装包优化
- **增强用户体验**
  - 自动检测系统架构
  - 提供清晰的架构选择说明
  - 优化安装程序大小和性能
  - 完善的卸载和升级机制

**发布日期**: 2025-07-15  
**版本状态**: 稳定版  
**提交哈希**: 待更新  

---

## [v3.1] - 2025-07-15

### 🐛 关键Bug修复
- **修复筛选完全失效的严重Bug**
  - 问题：当DHI数据无farm_id字段时，`apply_multi_filter_logic`函数错误跳过所有特殊筛选项
  - 影响：蛋白率、乳脂率等所有数值筛选完全失效
  - 修复：将farm_id检查改为可选，只要求management_id字段存在
  - 验证：单月和多月筛选均正常工作

### 🎨 界面显示优化
- **修复字体颜色显示问题**
  - 强制设置表格、文件信息、处理过程等界面为黑色字体
  - 确保在各种背景下文字都能清晰可见
  - 修复月度报告显示中的字体颜色问题

### 📤 数据导出修复
- **修复Excel导出错误**
  - 解决`create_monthly_report`中元组数据导致的"Cannot convert tuple to Excel"错误
  - 确保management_id数据格式一致性
  - 优化无farm_id数据的处理逻辑

### ✅ 验证项目
- [x] 单月数据筛选功能
- [x] 多月数据筛选功能  
- [x] 蛋白率/乳脂率筛选功能
- [x] 空值处理逻辑
- [x] 界面显示清晰度
- [x] Excel导出功能

**发布日期**: 2025-07-15  
**版本状态**: 稳定版  
**提交哈希**: bd75f73

---

## [v3.0] - 2025-07-08

### 🚀 重大功能升级

#### 新增核心功能
- **隐性乳房炎月度监测系统**
  - 当月流行率计算
  - 新发感染率计算
  - 慢性感染率计算
  - 慢性感染牛占比计算
  - 头胎/经产首测流行率计算
  - 干奶前流行率计算

- **慢性乳房炎筛查处置系统**
  - 5种处置办法判断逻辑
  - 智能条件匹配
  - 专业报告生成

- **牛群基础信息智能处理**
  - 支持伊起牛系统数据
  - 支持慧牧云系统数据
  - 支持自定义系统数据
  - 智能数据匹配算法

#### 用户体验优化
- **现代化界面设计**
  - 功能模块化布局
  - 智能颜色自适应
  - 响应式界面设计

- **防呆设计系统**
  - 详细计算过程展示
  - 完善的错误处理机制
  - 智能提示和引导

#### 技术架构升级
- **实时数据分析引擎**
- **灵活配置选项系统**
- **专业报告导出功能**
- **全面调试诊断系统**

**发布日期**: 2025-07-08  
**版本状态**: 稳定版  
**提交哈希**: fb71537

---

## [v2.x] - 开发阶段版本

### 功能迭代历程
- **GitHub Actions集成**: 自动化Windows EXE构建
- **Windows兼容性**: 解决文件命名和路径问题
- **PyInstaller优化**: 修复数据文件引用和numpy兼容性
- **安装包生成**: Inno Setup自动化打包
- **多架构支持**: 支持不同Windows版本

---

## [v1.x] - 初始版本

### 基础功能
- **DHI数据处理**: 基础的数据读取和处理功能
- **蛋白筛选**: 基本的蛋白率筛选逻辑
- **界面框架**: 初始的桌面应用界面

**发布日期**: 2025年初  
**版本状态**: 开发版

---

## 版本回退指南

### 如何回退到特定版本

1. **回退到v3.1 (推荐稳定版)**
   ```bash
   git checkout v3.1
   ```

2. **回退到v3.0 (功能完整版)**
   ```bash
   git checkout v3.0
   ```

3. **查看所有可用版本**
   ```bash
   git tag --list
   ```

4. **恢复到最新版本**
   ```bash
   git checkout main
   ```

### 版本选择建议

- **生产环境**: 推荐使用 `v3.1` (最新稳定版)
- **功能测试**: 可使用 `v3.0` (功能完整)
- **开发调试**: 使用 `main` 分支 (最新开发版)

---

## 更新计划

### 下一版本 (v3.2) 计划
- [ ] 性能优化
- [ ] 更多数据源支持
- [ ] 报告模板定制
- [ ] 批量处理功能

### 长期规划
- [ ] 云端数据同步
- [ ] 移动端支持
- [ ] 机器学习预测功能
- [ ] API接口开放

---

*最后更新: 2025-07-15*  
*维护者: DHI开发团队* 