# DHI精准筛查助手 - 操作说明

## 📋 快速上手指南

### 第一步：上传DHI报告文件
1. 点击 **"📁 选择文件"** 按钮
2. 选择您的DHI报告文件（支持 `.xlsx`、`.xls`、`.zip` 格式）
3. 等待文件处理完成（进度条显示处理过程）

### 第二步：设置筛选条件
1. **基础条件**：设置牛场编号、胎次范围、日期范围
2. **蛋白率筛选**：勾选启用，设置蛋白率范围和最少符合月数
3. **体细胞数筛选**：勾选启用，设置体细胞数范围和最少符合月数
4. **其他性状**：根据需要添加脂肪率、产奶量等筛选条件

### 第三步：开始筛选
1. 点击 **"🔍 开始筛选"** 按钮
2. 确认筛选条件后点击 **"是"**
3. 等待筛选完成（可随时点击"取消筛选"中断）

### 第四步：查看结果
1. **筛选结果**：查看符合条件的牛只数据
2. **筛选分析**：查看筛选率和统计信息
3. **性状分析**：查看各性状的详细统计图表

### 第五步：导出数据
1. 点击 **"📥 导出Excel"** 按钮
2. 选择保存位置
3. 导出的Excel文件包含完整的筛选结果和月度明细

---

## 🔧 高级功能

### 在群牛筛选（可选）
- 上传包含"耳号"列的Excel文件
- 系统会自动与DHI报告中的"管理号"匹配
- 只保留在群牛只的数据

### 多文件处理
- 支持同时上传多个DHI报告文件
- 系统会自动合并数据并检测重复
- 支持不同牧场号的文件统一处理

### 界面个性化
- 菜单栏 → 设置 → 界面显示设置
- 可调整显示缩放、字体、颜色等

---

## 📊 计算逻辑详解

### 1. 数据处理逻辑

#### 文件识别与解析
- **Excel文件**：自动检测表头位置（通常在第2-15行）
- **ZIP文件**：自动解压并处理内部的Excel文件
- **字段映射**：根据配置文件自动识别各种字段名称变体

#### 数据清洗
- **管理号标准化**：去除前导零（但保留单个"0"）
- **日期格式统一**：支持多种日期格式自动转换
- **数值字段验证**：过滤异常值和非数值数据

### 2. 筛选逻辑核心

#### 基础筛选
1. **牛场编号筛选**：精确匹配指定牛场
2. **胎次范围筛选**：保留指定胎次范围内的记录
3. **日期范围筛选**：根据取样日期进行时间段筛选

#### 多性状月度筛选（核心算法）

**工作原理：**
```
对于每头牛：
  1. 收集该牛所有月份的数据
  2. 对每个启用的筛选性状：
     - 逐月检查是否符合范围条件
     - 统计符合条件的月数
     - 判断是否达到"最少符合月数"要求
  3. 只有所有启用性状都达到要求的牛才会被保留
```

**具体计算步骤：**

1. **按牛只分组**：根据牛场编号+管理号唯一标识每头牛
2. **逐月判断**：
   - 检查该月该性状的数值是否在设定范围内
   - 空值处理：根据"空值判定"设置决定是否算作符合
3. **符合月数统计**：累计每头牛每个性状的符合月数
4. **综合判定**：所有启用性状的符合月数都≥最少要求月数

#### 示例计算

假设某头牛的蛋白率数据：
```
1月: 3.2%  → 符合(3.0-4.5%范围)  ✓
2月: 2.8%  → 不符合               ✗
3月: 3.8%  → 符合                ✓
4月: 空值   → 根据设置判断         ?
5月: 4.2%  → 符合                ✓
```

如果设置"最少符合月数=3"且"空值判断为符合=是"：
- 符合月数 = 4个月（1,3,4,5月）
- 判定结果：通过（4 ≥ 3）

### 3. 统计计算

#### 平均值计算
- **个体平均蛋白率**：使用产奶量加权平均
  ```
  加权平均 = Σ(蛋白率 × 产奶量) / Σ(产奶量)
  ```
- **月度平均值**：简单算术平均
- **群体统计**：基于所有符合条件牛只计算

#### 筛选率计算
```
筛选率 = (符合条件牛只数 / 筛选范围内牛只数) × 100%
```

### 4. 在群牛筛选逻辑

#### 管理号匹配算法
1. **标准化处理**：
   - DHI报告管理号：去除前导零
   - 在群牛耳号：去除前导零
2. **模糊匹配**：
   - 精确匹配优先
   - 支持不同长度的编号匹配
3. **匹配结果**：只保留匹配成功的牛只数据

### 5. 向量化优化

为提高大数据集处理速度，系统采用向量化算法：
- **批量条件判断**：使用pandas向量化操作
- **集合交集运算**：快速找出同时满足多个条件的牛只
- **内存优化**：及时清理临时数据，避免内存溢出

---

## ❓ 常见问题解答

### Q1：为什么我的文件无法识别？
**A：** 请检查：
- 文件格式是否为 `.xlsx`、`.xls` 或 `.zip`
- Excel文件是否包含必要的列（如管理号、胎次等）
- 数据是否在前15行有表头

### Q2：筛选结果为空是什么原因？
**A：** 可能原因：
- 筛选条件过于严格
- 数据中缺少相应的性状字段
- 最少符合月数设置过高
- 建议先使用较宽松的条件测试

### Q3：如何理解"最少符合月数"？
**A：** 这是判断某头牛是否符合筛选条件的关键参数：
- 设置为3：该牛至少要有3个月的数据符合范围要求
- 设置为0：只要有数据就算符合（用于包容性筛选）
- 推荐设置：数据总月数的1/3到1/2

### Q4：空值是否判断为符合如何选择？
**A：** 
- **勾选**：对缺失数据友好，适合数据不完整的情况
- **不勾选**：严格筛选，只考虑有实际数据的月份

### Q5：为什么筛选速度很慢？
**A：** 影响因素：
- 数据量大：建议分批处理
- 筛选项目多：减少同时启用的筛选项
- 最新版本已优化为向量化算法，速度显著提升

### Q6：导出的Excel文件包含什么内容？
**A：** 包含：
- 符合条件牛只的基本信息
- 各性状的月度明细数据
- 平均值和统计汇总
- 筛选条件说明

---

## 📞 技术支持

如遇到其他问题，请联系技术支持并提供：
1. 软件版本号
2. 错误信息截图
3. 问题复现步骤
4. 示例数据文件（脱敏处理）

**版本信息**：DHI精准筛查助手 v2.6
**更新日期**：2024年12月 