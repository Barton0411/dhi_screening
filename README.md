# DHI蛋白筛查系统 

一个专门用于分析奶牛DHI报告中蛋白质数据的桌面应用程序。系统采用PyQt6构建，提供直观的图形界面。

## 功能特性

- 🖥️ **纯桌面应用**：无需浏览器，直接运行
- 📁 **批量文件处理**：支持同时处理多个ZIP和Excel文件
- 🔍 **灵活筛选**：支持牛场编号、胎次、蛋白率、日期等多维度筛选
- 📊 **实时统计**：显示处理进度和结果统计
- 💾 **Excel导出**：一键导出筛选结果到Excel文件
- 🎨 **现代界面**：基于PyQt6的直观图形界面

## 系统要求

- Windows 10/11 或 macOS 10.14+ 或 Linux
- Python 3.8+
- 至少 4GB 内存
- 500MB 可用磁盘空间

## 快速开始

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 启动应用

```bash
python main.py
```

### 3. 使用界面

程序启动后会自动打开桌面应用程序窗口

## 配置文件说明

### rules.yaml
业务规则和字段映射配置文件，包含：
- 文件上传规则
- 中英文字段映射
- 筛选条件定义
- 导出列设置

### config.yaml  
系统全局配置文件，包含：
- 应用基本信息
- 上传限制设置
- API 服务配置
- 日志配置

## 使用流程

### 第一步：批量上传文件
1. 选择多个 ZIP/XLSX 文件进行批量上传
2. 系统从采样日期自动识别各文件的时间范围
3. 验证文件格式和表头结构
4. 自动提取所有文件中的牛场编号

### 第二步：选择筛选文件
1. 从文件列表中选择要参与筛选的文件（支持多选）
2. 点击"批量筛选选中文件"进入筛选设置

### 第三步：设置筛选条件
1. **选择筛选文件**：确认已选择的文件列表
2. **必选条件**：
   - 日期区间：设置采样日期范围
   - 牛场编号：从下拉列表中选择（支持多选）
   - 胎次范围：设置胎次最小值和最大值
   - 蛋白率范围：设置蛋白率筛选区间（3.10-9.00）

3. **可选条件**：
   - 勾选需要的额外筛选字段
   - 设置对应的数值范围

4. **选择显示字段**：
   - 选择在结果表中按月展示的数据字段
   - 如蛋白率、产奶量、乳脂率等

### 第四步：下载结果
1. 查看跨月筛选统计信息
2. 下载按月展开的 Excel 格式结果文件
3. 结果格式：牛场编号、管理号、胎次、各月份数据明细


## 文件结构

```
protein_screening/
├── main.py              # 桌面应用程序入口
├── desktop_app.py       # PyQt6桌面应用主界面
├── data_processor.py    # 数据处理核心模块
├── models.py           # 数据模型定义
├── requirements.txt    # Python 依赖
├── config.yaml         # 系统配置
├── rules.yaml          # 业务规则配置
├── 需求说明.md         # 需求文档
├── uploads/           # 上传文件存储
├── temp/              # 临时数据存储
└── exports/           # 导出文件存储
```

## 数据字段映射

| 中文字段 | 英文字段 | 类型 | 说明 |
|---------|---------|------|------|
| 牛场编号 | farm_id | 字符串 | 牛场唯一标识 |
| 管理号 | cow_id | 字符串 | 奶牛编号 |
| 胎次(胎) | parity | 数值 | 当前胎次 |
| 采样日期 | sample_date | 日期 | DHI采样日期 |
| 产奶量(Kg) | milk_yield | 数值 | 产奶量 |
| 乳脂率(%) | fat_pct | 数值 | 乳脂率百分比 |
| 蛋白率(%) | protein_pct | 数值 | 蛋白率百分比 |
| ... | ... | ... | 更多字段见 rules.yaml |

## 故障排除

### 常见问题

1. **文件上传失败**
   - 检查文件格式是否为 ZIP 或 XLSX
   - 确认文件大小不超过 100MB
   - 验证压缩包中是否包含 "04-2综合测定结果表.xlsx"

2. **表头验证失败**
   - 确保 Excel 文件包含 rules.yaml 中定义的所有必要列
   - 检查列名是否完全匹配（注意空格和特殊字符）

3. **筛选无结果**
   - 检查筛选条件是否过于严格
   - 确认日期格式和范围设置
   - 验证数值范围是否合理

### 日志查看

应用运行时会在控制台输出详细日志，包括：
- 文件处理状态
- 筛选条件应用过程
- 错误信息和堆栈跟踪

### 调试模式

修改 `config.yaml` 中的 `debug: true` 启用调试模式，可获得更详细的错误信息。

## 开发说明

### 添加新的筛选字段

1. 在 `rules.yaml` 的 `field_map` 中添加字段映射
2. 在 `filters` 中配置筛选规则
3. 前端会自动生成对应的 UI 控件

### 自定义导出格式

修改 `rules.yaml` 中的 `export.columns` 配置，支持：
- 简单字段列表
- 嵌套字段结构
- 多级表头定义

### 扩展文件格式支持

在 `data_processor.py` 中修改 `process_uploaded_file` 方法，添加新的文件格式处理逻辑。

## 许可证

本项目采用 MIT 许可证。

## 联系方式

如有问题或建议，请通过以下方式联系：
- 提交 Issue
- 发送邮件

---
*最后更新：2025-06-05*

## 版本更新 - 2025年1月

### 新增功能

#### 1. 老版本DHI报告兼容性支持 🆕
- ✅ **多种文件名支持**：
  - `04-2综合测定结果表.xlsx` (当前标准格式)
  - `04-2综合测定结果表.xls` (老版本Excel格式)
  - `04综合测定结果表.xlsx`
  - `04综合测定结果表.xls`
  - `综合测定结果表.xlsx`
  - `综合测定结果表.xls`

- ✅ **递归文件搜索**：自动在ZIP包的所有子文件夹中搜索目标Excel文件

- ✅ **智能表头检测**：
  - 自动检测表头位置（支持前15行内的表头）
  - 通过关键字段识别表头：["管理号", "牛号", "胎次", "采样日期", "蛋白率"]

- ✅ **老版本字段映射**：
  - 支持"牛号"字段（老版本）映射到"管理号"
  - 支持无括号的字段名：如"胎次"、"蛋白率"、"泌乳天数"、"产奶量"

- ✅ **缺少牛场编号处理**：
  - 自动检测老版本报告中缺少的牛场编号字段
  - 弹出对话框提示用户输入牛场编号
  - 为整个文件的所有牛只统一分配牛场编号

- ✅ **汇总行过滤**：
  - 自动过滤掉"小计"、"平均与总计"、"合计"、"总计"、"平均"等汇总行
  - 确保只保留单头牛的真实数据

#### 2. 产奶量明细功能
- ✅ **结果表中新增产奶量列**：在月度报告中的每个月份数据旁边显示对应的产奶量(Kg)
- ✅ **产奶量字段映射**：在 `rules.yaml` 中添加了 `产奶量(Kg): milk_yield` 字段映射
- ✅ **产奶量显示样式**：
  - 界面显示：产奶量列使用浅绿色背景 (rgb(240, 255, 240))
  - 表头样式：产奶量列表头使用绿色背景 (#d3f5d3)
  - Excel导出：同样应用绿色主题样式

#### 3. 平均蛋白率计算方法优化
- ✅ **加权平均算法**：将原来的简单算术平均改为产奶量加权平均
  - 单头牛平均蛋白率 = Σ(单次蛋白率 × 单次产奶量) / Σ(单次产奶量)
  - 当月所有牛平均蛋白率 = Σ(各牛当月蛋白率 × 各牛当月产奶量) / Σ(各牛当月产奶量)
  - 总体平均蛋白率 = Σ(所有记录蛋白率 × 所有记录产奶量) / Σ(所有记录产奶量)

#### 4. 计算方法说明
- ✅ **配置文件说明**：在 `rules.yaml` 中添加了计算方法的详细说明
- ✅ **界面显示说明**：在统计信息面板中显示计算方法说明
- ✅ **明确标注**：采用产奶量加权平均的方式计算平均蛋白率，而非简单算术平均

### 修改的文件

1. **rules.yaml**
   - 新增产奶量字段映射：`产奶量(Kg): milk_yield`
   - 添加老版本字段映射支持：`牛号: management_id`，`胎次: parity` 等
   - 新增老版本支持配置：表头检测、汇总行过滤关键字
   - 支持多种内部目标文件名列表：`internal_targets`
   - 启用递归搜索：`recursive_search: true`
   - 在导出配置中包含产奶量字段
   - 添加计算方法说明文档

2. **data_processor.py**
   - 在数据类型转换中添加 `milk_yield` 字段处理
   - 修改 `_process_zip_file` 方法：支持递归搜索和多种文件名
   - 新增 `_detect_header_row` 方法：自动检测表头位置
   - 新增 `_filter_summary_rows` 方法：过滤汇总行数据
   - 新增 `_check_farm_id_column` 方法：检查牛场编号列
   - 修改 `_process_excel_file` 方法：支持老版本兼容性处理
   - 修改 `create_monthly_report` 方法：
     - 添加产奶量列到月度报告
     - 修改平均蛋白率计算为加权平均
     - 修改月度平均值计算为加权平均
     - 修改总平均值计算为加权平均

3. **desktop_app.py**
   - 新增 `handle_missing_farm_id` 方法：处理缺少牛场编号的用户交互
   - 新增 `add_farm_id_to_data` 方法：为数据添加用户输入的牛场编号
   - 修改 `file_processed` 方法：检测并处理missing_farm_id_info
   - 修改 `FileProcessThread`：传递missing_farm_id_info信息给界面
   - 在 `display_results` 方法中：
     - 添加产奶量列的背景色处理
     - 添加产奶量列的表头样式
   - 在 `show_statistics` 方法中：
     - 添加产奶量月度统计
     - 添加计算方法说明
   - 在 `_export_formatted_excel` 方法中：
     - 支持产奶量列的导出格式

### 数据流程优化

1. **数据读取**：Excel文件中的"产奶量(Kg)"列现在会被正确识别和转换
2. **数据处理**：产奶量数据参与蛋白率的加权平均计算
3. **结果显示**：
   - 预览表格：按月显示蛋白率、产奶量、泌乳天数三列数据
   - 统计面板：显示各月产奶量统计和计算方法说明
4. **结果导出**：Excel文件包含完整的产奶量数据和格式

### 界面改进

- **可视化区分**：
  - 蛋白率列：黄色主题
  - 产奶量列：绿色主题  
  - 泌乳天数列：蓝色主题
- **信息完整性**：统计面板现在显示完整的计算方法说明，用户可以清楚了解平均值的计算逻辑

### 技术说明

本次更新确保了：
1. 向后兼容：现有数据和功能完全保持兼容
2. 数据准确性：采用产奶量加权的方式使平均蛋白率更能反映实际生产情况
3. 用户体验：清晰的颜色编码和详细的计算说明帮助用户理解数据

---

## 项目背景
本工具用于对奶牛 DHI 报告中的 **04-2 综合测定结果表** 进行批量筛查与统计，支持用户直接上传压缩包或表格文件，通过自定义区间与指标进行过滤后，导出符合条件的结果表。

## 输入数据
1. **压缩包 ZIP**：命名格式 `151537(YYYY-MM)牛场名称.zip`，内部包含 `04-2综合测定结果表.xlsx`。
2. **单独 Excel**：亦可直接上传 `04-2综合测定结果表.xlsx`。
3. 文件编码：UTF-8 / Excel 2007+ (`.xlsx`)。

## 表头字段
| 中文列名 | 英文字段 | 说明 |
| -------- | -------- | ---- |
| 序号 | index | 自增序号 |
| 牛场编号 | farm_id | 牛场唯一编号 |
| 管理号 | cow_id | 单牛唯一编号 |
| 胎次(胎) | parity | 当前胎次 |
| 采样日期 | sample_date | DHI 采样日期 |
| 产犊日期 | calving_date | 最近一次产犊日 |
| 产犊间隔(天) | calving_interval | 两次产犊间隔 |
| 泌乳天数(天) | lactation_days | 本泌乳期天数 |
| 分组号 | group_no | 牧场内部分组 |
| 产奶量(Kg) | milk_yield | 本次采样产奶量 |
| 乳脂率(%) | fat_pct | 本次乳脂率 |
| 蛋白率(%) | protein_pct | 本次蛋白率 |
| … | … | 其余字段见 rules.yaml |

> **完整映射** 见 `rules.yaml` `field_map`。

## 功能需求
1. **文件上传**
   * 支持单文件或批量压缩包上传。
   * 系统自动解析文件名中的 `(YYYY-MM)` 作为月份，若失败则提示用户输入。
2. **数据解析**
   * 自动解压并定位 `04-2综合测定结果表.xlsx`。
   * 按 `field_map` 将中文列名统一转换为英文字段名。
3. **筛查过滤**
   * **必选过滤项**：日期区间（sample_date）、牛场编号（farm_id）、胎次（parity）、蛋白率（protein_pct）必须始终启用。
   * **可选过滤项**：其余字段（如乳脂率、产奶量、体细胞数等）由用户在界面勾选启用；启用后其配置（min/max/列表）写回 `rules.yaml`。
   * 前端渲染规则：读取 `filters` 中 `required` 标记或 `enabled` 状态，动态生成表单。
4. **结果导出**
   * 生成 `筛选结果表_{日期}.xlsx`，包含：牛场编号、管理号、胎次及按月份展开的蛋白率/乳脂率/产奶量明细。
   * 支持多级表头或列展开。
5. **错误提示**
   * 表头缺失或不匹配 → 返回缺失字段列表。
   * 未找到目标 Excel → 提示检查压缩包。

## 非功能需求
* 桌面应用基于 PyQt6，提供直观的图形界面。
* 大文件上传限制 100 MB；使用临时目录做解压，完成后删除。
* 代码需配套单元测试，覆盖率 ≥ 80 %。

## 配置文件
| 文件 | 作用 |
| ---- | ---- |
| `rules.yaml` | 业务规则与字段映射（本项目核心） |
| `config.yaml` | 通用配置：上传大小、缓存路径、默认过滤值 |
| `requirements.txt` | Python 依赖列表 |
| `.env` | 环境变量（数据库、日志级别） |

---
_last updated: 2025-01-22_ 