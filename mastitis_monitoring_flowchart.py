#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import matplotlib.pyplot as plt
import matplotlib.patches as patches
from matplotlib.patches import FancyBboxPatch
import numpy as np

# è®¾ç½®ä¸­æ–‡å­—ä½“
plt.rcParams['font.sans-serif'] = ['SimHei', 'Arial Unicode MS', 'DejaVu Sans']
plt.rcParams['axes.unicode_minus'] = False

def create_mastitis_monitoring_flowchart():
    """åˆ›å»ºéšå½¢ä¹³æˆ¿ç‚æœˆåº¦ç›‘æµ‹é€»è¾‘æµç¨‹å›¾"""
    
    # åˆ›å»ºå›¾å½¢
    fig, ax = plt.subplots(1, 1, figsize=(20, 24))
    ax.set_xlim(0, 100)
    ax.set_ylim(0, 120)
    ax.axis('off')
    
    # å®šä¹‰é¢œè‰²
    colors = {
        'start': '#4CAF50',      # ç»¿è‰² - å¼€å§‹
        'process': '#2196F3',    # è“è‰² - å¤„ç†
        'decision': '#FF9800',   # æ©™è‰² - åˆ¤æ–­
        'data': '#9C27B0',      # ç´«è‰² - æ•°æ®
        'result': '#F44336',     # çº¢è‰² - ç»“æœ
        'config': '#607D8B'      # ç°è“è‰² - é…ç½®
    }
    
    def add_box(x, y, width, height, text, color, fontsize=9):
        """æ·»åŠ æ–‡æœ¬æ¡†"""
        box = FancyBboxPatch((x-width/2, y-height/2), width, height,
                           boxstyle="round,pad=0.3", 
                           facecolor=color, edgecolor='black', linewidth=1.5)
        ax.add_patch(box)
        ax.text(x, y, text, ha='center', va='center', fontsize=fontsize, 
               weight='bold', color='white', wrap=True)
    
    def add_diamond(x, y, width, height, text, color, fontsize=8):
        """æ·»åŠ è±å½¢åˆ¤æ–­æ¡†"""
        diamond = patches.RegularPolygon((x, y), 4, radius=width/1.4, 
                                       orientation=np.pi/4, 
                                       facecolor=color, edgecolor='black', linewidth=1.5)
        ax.add_patch(diamond)
        ax.text(x, y, text, ha='center', va='center', fontsize=fontsize, 
               weight='bold', color='white', wrap=True)
    
    def add_arrow(x1, y1, x2, y2, text=''):
        """æ·»åŠ ç®­å¤´"""
        ax.annotate('', xy=(x2, y2), xytext=(x1, y1),
                   arrowprops=dict(arrowstyle='->', lw=2, color='black'))
        if text:
            mid_x, mid_y = (x1 + x2) / 2, (y1 + y2) / 2
            ax.text(mid_x + 2, mid_y, text, fontsize=8, color='red', weight='bold')
    
    # æ ‡é¢˜
    ax.text(50, 115, 'éšå½¢ä¹³æˆ¿ç‚æœˆåº¦ç›‘æµ‹ - å®Œæ•´é€»è¾‘æµç¨‹å›¾', 
           ha='center', va='center', fontsize=18, weight='bold', color='#333')
    
    # ç¬¬ä¸€å±‚ï¼šç³»ç»Ÿå…¥å£å’Œæ•°æ®å‡†å¤‡
    add_box(50, 108, 24, 4, 'ç”¨æˆ·è¿›å…¥éšå½¢ä¹³æˆ¿ç‚æœˆåº¦ç›‘æµ‹åŠŸèƒ½', colors['start'])
    
    add_diamond(50, 101, 20, 6, 'æ£€æŸ¥æ…¢æ€§ä¹³æˆ¿ç‚\nç­›æŸ¥ä¸­çš„ç‰›ç¾¤\nåŸºç¡€ä¿¡æ¯', colors['decision'])
    
    add_box(20, 95, 16, 4, 'æç¤ºç”¨æˆ·å…ˆåœ¨æ…¢æ€§ä¹³æˆ¿ç‚\nç­›æŸ¥ä¸­ä¸Šä¼ ç‰›ç¾¤åŸºç¡€ä¿¡æ¯', colors['result'])
    add_box(80, 95, 16, 4, 'è·å–å·²ä¿å­˜çš„ç³»ç»Ÿç±»å‹\nä¼Šèµ·ç‰›/æ…§ç‰§äº‘/å…¶ä»–', colors['process'])
    
    # ç®­å¤´
    add_arrow(50, 106, 50, 103)
    add_arrow(42, 98, 28, 95, 'æ— ç‰›ç¾¤ä¿¡æ¯')
    add_arrow(58, 98, 72, 95, 'æœ‰ç‰›ç¾¤ä¿¡æ¯')
    add_arrow(20, 93, 15, 88)
    add_arrow(15, 88, 15, 110)
    add_arrow(15, 110, 42, 108)
    
    # ç¬¬äºŒå±‚ï¼šæ•°æ®å¤„ç†
    add_box(50, 88, 20, 4, 'DHIæŠ¥å‘Šæ–‡ä»¶ä¸Šä¼ å’Œå¤„ç†', colors['data'])
    add_box(20, 81, 18, 4, 'è¡¨å¤´æ£€æµ‹å’Œå­—æ®µæ˜ å°„\næ ‡å‡†åŒ–ç®¡ç†å·(å»å‰å¯¼0)', colors['process'])
    add_box(50, 81, 18, 4, 'æŒ‰é‡‡æ ·æ—¥æœŸåˆ†ç»„æœˆåº¦æ•°æ®\nåŒæœˆå¤šæ¬¡æµ‹å®šå–æœ€åä¸€æ¬¡', colors['process'])
    add_box(80, 81, 18, 4, 'ç‰›ç¾¤åŸºç¡€ä¿¡æ¯å¤„ç†\næ ‡å‡†åŒ–è€³å·(å»å‰å¯¼0)', colors['process'])
    
    add_arrow(50, 86, 50, 83)
    add_arrow(42, 83, 30, 83)
    add_arrow(58, 83, 70, 83)
    add_arrow(80, 93, 80, 83)
    
    # ç¬¬ä¸‰å±‚ï¼šæœˆåº¦è¿ç»­æ€§æ£€æŸ¥
    add_diamond(50, 74, 18, 6, 'æœˆåº¦æ•°æ®\nè¿ç»­æ€§æ£€æŸ¥', colors['decision'])
    
    add_box(15, 67, 14, 4, 'åªæœ‰1ä¸ªæœˆæ•°æ®\næ˜¾ç¤ºæ•°å€¼ï¼Œä¸ç»˜å›¾', colors['result'])
    add_box(50, 67, 14, 4, 'â‰¥2ä¸ªæœˆä¸”è¿ç»­\nè®¡ç®—æ‰€æœ‰æŒ‡æ ‡', colors['result'])
    add_box(85, 67, 14, 4, 'â‰¥2ä¸ªæœˆä½†ä¸è¿ç»­\næç¤ºç¼ºå¤±æœˆä»½', colors['decision'])
    
    add_arrow(50, 79, 50, 76)
    add_arrow(44, 71, 22, 69, '1ä¸ªæœˆ')
    add_arrow(50, 71, 50, 69, 'è¿ç»­')
    add_arrow(56, 71, 78, 69, 'ä¸è¿ç»­')
    
    # ç¬¬å››å±‚ï¼šæŒ‡æ ‡è®¡ç®—åŒºåŸŸ
    ax.text(50, 60, '5ä¸ªæ ¸å¿ƒæŒ‡æ ‡è®¡ç®—é€»è¾‘', ha='center', va='center', 
           fontsize=14, weight='bold', color='#333', 
           bbox=dict(boxstyle="round,pad=0.5", facecolor='lightgray', alpha=0.7))
    
    # æŒ‡æ ‡1ï¼šå½“æœˆæµè¡Œç‡
    add_box(10, 55, 18, 6, 'æŒ‡æ ‡1: å½“æœˆæµè¡Œç‡\n\nå…¬å¼ï¼šä½“ç»†èƒæ•°>é˜ˆå€¼çš„ç‰›å¤´æ•° / å½“æœˆå‚æµ‹ç‰›å¤´æ•°\nç¤ºä¾‹ï¼šSCC>20ä¸‡çš„168å¤´ / æ€»982å¤´ = 17.1%\n\næ•°æ®æºï¼šDHIæŠ¥å‘Šå½“æœˆæ•°æ®', colors['data'], 8)
    
    # æŒ‡æ ‡2ï¼šæ–°å‘æ„ŸæŸ“ç‡
    add_box(30, 55, 18, 6, 'æŒ‡æ ‡2: æ–°å‘æ„ŸæŸ“ç‡\n\nå…¬å¼ï¼š(å½“æœˆSCC>é˜ˆå€¼ ä¸” ä¸ŠæœˆSCCâ‰¤é˜ˆå€¼) / ä¸ŠæœˆSCCâ‰¤é˜ˆå€¼\nç¤ºä¾‹ï¼š(06æœˆ>20 ä¸” 05æœˆâ‰¤20)45å¤´ / 05æœˆâ‰¤20çš„758å¤´ = 5.9%\n\næ•°æ®æºï¼šè¿ç»­ä¸¤æœˆé‡å ç‰›åª', colors['data'], 8)
    
    # æŒ‡æ ‡3ï¼šæ…¢æ€§æ„ŸæŸ“ç‡
    add_box(50, 55, 18, 6, 'æŒ‡æ ‡3: æ…¢æ€§æ„ŸæŸ“ç‡\n\nå…¬å¼ï¼š(å½“æœˆSCC>é˜ˆå€¼ ä¸” ä¸ŠæœˆSCC>é˜ˆå€¼) / ä¸ŠæœˆSCC>é˜ˆå€¼\nç¤ºä¾‹ï¼š(06æœˆ>20 ä¸” 05æœˆ>20)123å¤´ / 05æœˆ>20çš„214å¤´ = 57.5%\n\næ•°æ®æºï¼šè¿ç»­ä¸¤æœˆé‡å ç‰›åª', colors['data'], 8)
    
    # æŒ‡æ ‡4ï¼šæ…¢æ€§æ„ŸæŸ“ç‰›å æ¯”
    add_box(70, 55, 18, 6, 'æŒ‡æ ‡4: æ…¢æ€§æ„ŸæŸ“ç‰›å æ¯”\n\nå…¬å¼ï¼š(å½“æœˆSCC>é˜ˆå€¼ ä¸” ä¸ŠæœˆSCC>é˜ˆå€¼) / å½“æœˆå‚æµ‹ç‰›å¤´æ•°\nç¤ºä¾‹ï¼š(06æœˆ>20 ä¸” 05æœˆ>20)123å¤´ / 06æœˆå‚æµ‹972å¤´ = 12.7%\n\næ•°æ®æºï¼šè¿ç»­ä¸¤æœˆé‡å ç‰›åª', colors['data'], 8)
    
    # æŒ‡æ ‡5ï¼šå¤´èƒ/ç»äº§é¦–æµ‹æµè¡Œç‡
    add_box(90, 55, 18, 6, 'æŒ‡æ ‡5: å¤´èƒ/ç»äº§é¦–æµ‹æµè¡Œç‡\n\nç­›é€‰ï¼šæ³Œä¹³å¤©æ•°5-35å¤©\nå¤´èƒå…¬å¼ï¼šå¤´èƒSCC>é˜ˆå€¼ / å¤´èƒå‚æµ‹ç‰›æ•°\nç»äº§å…¬å¼ï¼šç»äº§SCC>é˜ˆå€¼ / ç»äº§å‚æµ‹ç‰›æ•°\n\næ•°æ®æºï¼šDHIæŠ¥å‘Šå½“æœˆæ•°æ®', colors['data'], 8)
    
    # è¿æ¥çº¿åˆ°æŒ‡æ ‡è®¡ç®—
    add_arrow(15, 65, 15, 58)
    add_arrow(50, 65, 50, 58)
    add_arrow(85, 65, 85, 58)
    
    # ç¬¬äº”å±‚ï¼šå¹²å¥¶å‰æµè¡Œç‡ï¼ˆç‰¹æ®Šå¤„ç†ï¼‰
    add_box(50, 45, 35, 6, 'æŒ‡æ ‡6: å¹²å¥¶å‰æµè¡Œç‡ï¼ˆéœ€è¦ç‰›ç¾¤åŸºç¡€ä¿¡æ¯åŒ¹é…ï¼‰\n\n1. ç®¡ç†å·ä¸è€³å·åŒ¹é…ï¼ˆæ ‡å‡†åŒ–åå¯¹æ¯”ï¼‰\n2. ç­›é€‰æ¡ä»¶ï¼šåœ¨èƒå¤©æ•°>180å¤©ï¼ˆä¼Šèµ·ç‰›ç³»ç»Ÿï¼‰æˆ– æ€€å­•å¤©æ•°>180å¤©ï¼ˆæ…§ç‰§äº‘ç³»ç»Ÿï¼‰\n3. å…¬å¼ï¼šç­›é€‰ç‰›åªä¸­SCC>é˜ˆå€¼çš„ç‰›å¤´æ•° / ç­›é€‰ç‰›åªå‚æµ‹æ€»æ•°ï¼ˆæˆåŠŸåŒ¹é…çš„ï¼‰\n4. ç¤ºä¾‹ï¼šåœ¨èƒå¤©æ•°>180å¤©ä¸”SCC>20çš„34å¤´ / åœ¨èƒå¤©æ•°>180å¤©å‚æµ‹127å¤´ = 26.8%', colors['process'], 9)
    
    # ç¬¬å…­å±‚ï¼šé…ç½®å’Œå¼‚å¸¸å¤„ç†
    add_box(15, 35, 16, 5, 'é…ç½®é€‰é¡¹\n\nâ€¢ ä½“ç»†èƒé˜ˆå€¼ï¼šç”¨æˆ·å¯è°ƒæ•´\nâ€¢ Yè½´èŒƒå›´ï¼šåŠ¨æ€è°ƒæ•´+æ‰‹åŠ¨è®¾ç½®\nâ€¢ æ—¶é—´æ˜¾ç¤ºï¼šæŒ‰è‡ªç„¶æœˆ\nâ€¢ ç³»ç»Ÿç±»å‹ï¼šè‡ªåŠ¨è¯†åˆ«', colors['config'], 8)
    
    add_box(50, 35, 16, 5, 'å¼‚å¸¸å¤„ç†\n\nâ€¢ æ•°æ®ç¼ºå¤±ï¼šæ˜¾ç¤ºå…·ä½“åŸå› \nâ€¢ åŒ¹é…å¤±è´¥ï¼šæ˜¾ç¤ºæˆåŠŸ/å¤±è´¥æ•°é‡\nâ€¢ æœˆä»½ä¸è¿ç»­ï¼šæç¤ºç”¨æˆ·ç¡®è®¤\nâ€¢ å­—æ®µç¼ºå¤±ï¼šå…·ä½“é”™è¯¯ä¿¡æ¯', colors['result'], 8)
    
    add_box(85, 35, 16, 5, 'ç»“æœå±•ç¤º\n\nå•æœˆï¼šæ•°å€¼+å…¬å¼è¯¦æƒ…\nå¤šæœˆï¼šæ•°æ®è¡¨æ ¼+æŠ˜çº¿å›¾\nè¶‹åŠ¿ï¼š4ä¸ªæŒ‡æ ‡ç»˜åˆ¶è¶‹åŠ¿\nå¹²å¥¶å‰ï¼šå•ç‹¬æ˜¾ç¤ºæœ€æ–°å€¼', colors['result'], 8)
    
    # ç¬¬ä¸ƒå±‚ï¼šè¯¦ç»†è®¡ç®—ç¤ºä¾‹
    ax.text(50, 25, 'è®¡ç®—å…¬å¼è¯¦ç»†ç¤ºä¾‹', ha='center', va='center', 
           fontsize=12, weight='bold', color='#333')
    
    example_text = """
å½“æœˆæµè¡Œç‡è®¡ç®—ç¤ºä¾‹ï¼š
ä½“ç»†èƒæ•°(ä¸‡/ml)>20çš„ç‰›å¤´æ•°(168) Ã· é‡‡æ ·æ—¥æœŸä¸º2025-06çš„æ€»ç‰›å¤´æ•°(982) = 17.1%

æ–°å‘æ„ŸæŸ“ç‡è®¡ç®—ç¤ºä¾‹ï¼š
(2025-06æœˆSCC>20 ä¸” 2025-05æœˆSCCâ‰¤20çš„ç‰›å¤´æ•°(45)) Ã· (2025-05æœˆSCCâ‰¤20çš„ç‰›å¤´æ•°(758)) = 5.9%

å¤´èƒé¦–æµ‹æµè¡Œç‡è®¡ç®—ç¤ºä¾‹ï¼š
(èƒæ¬¡=1 ä¸” æ³Œä¹³å¤©æ•°5-35å¤© ä¸” SCC>20çš„ç‰›å¤´æ•°(23)) Ã· (èƒæ¬¡=1 ä¸” æ³Œä¹³å¤©æ•°5-35å¤©çš„å‚æµ‹ç‰›å¤´æ•°(89)) = 25.8%

å¹²å¥¶å‰æµè¡Œç‡è®¡ç®—ç¤ºä¾‹ï¼š
(åœ¨èƒå¤©æ•°>180å¤© ä¸” SCC>20çš„ç‰›å¤´æ•°(34)) Ã· (åœ¨èƒå¤©æ•°>180å¤©çš„å‚æµ‹ç‰›å¤´æ•°(127ï¼Œå·²æˆåŠŸåŒ¹é…)) = 26.8%
æ³¨ï¼š127å¤´ä¸ºç®¡ç†å·ä¸è€³å·æˆåŠŸåŒ¹é…çš„ç‰›åªæ•°ï¼Œå…¶ä½™ç‰›åªå› åŒ¹é…å¤±è´¥è€Œæ’é™¤
"""
    
    ax.text(50, 15, example_text, ha='center', va='center', fontsize=9, 
           bbox=dict(boxstyle="round,pad=0.8", facecolor='lightyellow', alpha=0.8))
    
    # ç¬¬å…«å±‚ï¼šå…³é”®æŠ€æœ¯ç‚¹
    tech_points = """
å…³é”®æŠ€æœ¯è¦ç‚¹ï¼š
1. ç®¡ç†å·ä¸è€³å·æ ‡å‡†åŒ–ï¼šç»Ÿä¸€å»é™¤å‰å¯¼0åè¿›è¡ŒåŒ¹é…
2. åŒæœˆå¤šæ¬¡æµ‹å®šå¤„ç†ï¼šæŒ‰é‡‡æ ·æ—¥æœŸæ’åºï¼Œå–å½“æœˆæœ€åä¸€æ¬¡è®°å½•
3. ç³»ç»Ÿå­—æ®µæ˜ å°„ï¼šä¼Šèµ·ç‰›ç”¨'åœ¨èƒå¤©æ•°'ï¼Œæ…§ç‰§äº‘ç”¨'æ€€å­•å¤©æ•°'ï¼Œå…¶ä»–ç³»ç»Ÿç”¨æˆ·è‡ªå®šä¹‰
4. æœˆä»½è¿ç»­æ€§ï¼šéè¿ç»­æœˆä»½æç¤ºç”¨æˆ·ç¡®è®¤æ˜¯å¦ç»§ç»­è®¡ç®—
5. å…¬å¼é€æ˜åŒ–ï¼šæ¯ä¸ªæŒ‡æ ‡éƒ½æ˜¾ç¤ºè¯¦ç»†è®¡ç®—è¿‡ç¨‹å’Œæ•°æ®æ¥æº
"""
    
    ax.text(50, 5, tech_points, ha='center', va='center', fontsize=9, 
           bbox=dict(boxstyle="round,pad=0.8", facecolor='lightblue', alpha=0.8))
    
    plt.tight_layout()
    plt.savefig('/Users/Shared/Files From d.localized/projects/protein_screening/éšå½¢ä¹³æˆ¿ç‚æœˆåº¦ç›‘æµ‹é€»è¾‘æµç¨‹å›¾.png', 
                dpi=300, bbox_inches='tight', facecolor='white')
    plt.show()
    
    return fig

if __name__ == "__main__":
    fig = create_mastitis_monitoring_flowchart()
    print("âœ… éšå½¢ä¹³æˆ¿ç‚æœˆåº¦ç›‘æµ‹é€»è¾‘æµç¨‹å›¾å·²ç”Ÿæˆ")
    print("ğŸ“ ä¿å­˜ä½ç½®: /Users/Shared/Files From d.localized/projects/protein_screening/éšå½¢ä¹³æˆ¿ç‚æœˆåº¦ç›‘æµ‹é€»è¾‘æµç¨‹å›¾.png")