name: Build Windows EXE and Upload to OneDrive

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows-exe:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        architecture: 'x64'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install -r requirements.txt
        Write-Host "âœ… ä¾èµ–å®‰è£…æˆåŠŸ"
    
    - name: Build EXE with PyInstaller
      run: |
        Write-Host "ğŸ”¨ å¼€å§‹æ„å»ºWindowså¯æ‰§è¡Œæ–‡ä»¶..."
        pyinstaller --clean --noconfirm "DHI_Screening_System_v3.3.spec"
        
        $exePath = "dist\DHI_Screening_System_v3.3\DHI_Screening_System_v3.3.exe"
        if (Test-Path $exePath) {
          $fileSize = (Get-Item $exePath).Length / 1MB
          Write-Host "âœ… EXEæ„å»ºæˆåŠŸ: $([math]::Round($fileSize, 2)) MB"
        } else {
          Write-Host "âŒ EXEæ„å»ºå¤±è´¥"
          exit 1
        }
    
    - name: Prepare upload package
      run: |
        Write-Host "ğŸ“¦ å‡†å¤‡ä¸Šä¼ åŒ…..."
        
        $uploadDir = "upload_package"
        if (Test-Path $uploadDir) {
          Remove-Item -Recurse -Force $uploadDir
        }
        New-Item -ItemType Directory -Path $uploadDir
        
        $distDir = "dist\DHI_Screening_System_v3.3"
        if (Test-Path $distDir) {
          Copy-Item -Path "$distDir\*" -Destination $uploadDir -Recurse
          Write-Host "âœ… EXEæ–‡ä»¶å·²å¤åˆ¶åˆ°ä¸Šä¼ ç›®å½•"
        }
        
        $docFiles = @("README.md", "LICENSE.txt", "CHANGELOG.md", "whg3r-qi1nv-001.ico")
        foreach ($file in $docFiles) {
          if (Test-Path $file) {
            Copy-Item -Path $file -Destination $uploadDir
            Write-Host "âœ… å·²å¤åˆ¶: $file"
          }
        }
        
        $buildTime = Get-Date -Format 'yyyy-MM-dd HH:mm:ss'
        $versionContent = "DHIç²¾å‡†ç­›æŸ¥åŠ©æ‰‹ v3.3`næ„å»ºæ—¶é—´: $buildTime`næ„å»ºåˆ†æ”¯: $env:GITHUB_REF_NAME`næäº¤å“ˆå¸Œ: $env:GITHUB_SHA`næ„å»ºå·: $env:GITHUB_RUN_NUMBER`n`nç³»ç»Ÿè¦æ±‚:`n- Windows 7/8/10/11 (32ä½æˆ–64ä½)`n- å†…å­˜: 4GB RAM æ¨è`n- ç¡¬ç›˜: 100MB å¯ç”¨ç©ºé—´`n`nä½¿ç”¨è¯´æ˜:`n1. ç›´æ¥è¿è¡Œ DHI_Screening_System_v3.3.exe`n2. é¦–æ¬¡ä½¿ç”¨è¯·å‚è€ƒ README.md`n3. å¦‚æœ‰é—®é¢˜è¯·æŸ¥çœ‹ CHANGELOG.md`n`næŠ€æœ¯æ”¯æŒ: ä¼Šåˆ©æ¶²å¥¶å¥¶ç§‘é™¢"
        
        $versionContent | Out-File -FilePath "$uploadDir\version_info.txt" -Encoding UTF8
        
        Write-Host "ğŸ“‹ ä¸Šä¼ åŒ…å†…å®¹:"
        Get-ChildItem $uploadDir | Format-Table Name, Length, LastWriteTime
        
        $totalSize = (Get-ChildItem $uploadDir -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
        Write-Host "ğŸ“Š ä¸Šä¼ åŒ…æ€»å¤§å°: $([math]::Round($totalSize, 2)) MB"
    
    - name: Install rclone
      run: |
        Write-Host "ğŸ“¥ å®‰è£…rclone..."
        $rcloneUrl = "https://downloads.rclone.org/rclone-current-windows-amd64.zip"
        $rcloneZip = "rclone.zip"
        
        Invoke-WebRequest -Uri $rcloneUrl -OutFile $rcloneZip
        Expand-Archive -Path $rcloneZip -DestinationPath "." -Force
        
        $rcloneExe = Get-ChildItem -Path ".\rclone-*" -Name "rclone.exe" -Recurse | Select-Object -First 1
        if ($rcloneExe) {
          Copy-Item -Path $rcloneExe.FullName -Destination ".\rclone.exe"
          Write-Host "âœ… rcloneå®‰è£…æˆåŠŸ"
        } else {
          Write-Host "âŒ rcloneå®‰è£…å¤±è´¥"
          exit 1
        }
    
    - name: Configure OneDrive and Upload
      env:
        ONEDRIVE_TOKEN: ${{ secrets.ONEDRIVE_TOKEN }}
      run: |
        Write-Host "â˜ï¸ é…ç½®OneDriveè¿æ¥..."
        
        if (-not $env:ONEDRIVE_TOKEN) {
          Write-Host "âš ï¸ æœªé…ç½®OneDrive tokenï¼Œè·³è¿‡ä¸Šä¼ "
          Write-Host "ğŸ“ è¯·åœ¨GitHubä»“åº“è®¾ç½®ä¸­æ·»åŠ  ONEDRIVE_TOKEN secret"
          exit 0
        }
        
        $rcloneConfig = "[onedrive]`ntype = onedrive`ntoken = $env:ONEDRIVE_TOKEN`ndrive_id = `ndrive_type = personal"
        
        $configDir = "$env:APPDATA\rclone"
        if (-not (Test-Path $configDir)) {
          New-Item -ItemType Directory -Path $configDir -Force
        }
        
        $rcloneConfig | Out-File -FilePath "$configDir\rclone.conf" -Encoding UTF8
        
        $timestamp = Get-Date -Format 'yyyyMMdd_HHmmss'
        $remotePath = "DHI_Screening_System/releases/v3.3_$timestamp"
        
        Write-Host "ğŸ“¤ å¼€å§‹ä¸Šä¼ åˆ°OneDrive: $remotePath"
        
        try {
          .\rclone.exe copy "upload_package" "onedrive:$remotePath" --progress --verbose
          
          if ($LASTEXITCODE -eq 0) {
            Write-Host "âœ… ä¸Šä¼ æˆåŠŸ!"
            Write-Host "ğŸ“‚ OneDriveè·¯å¾„: $remotePath"
            
            Write-Host "ğŸ“‹ å·²ä¸Šä¼ çš„æ–‡ä»¶:"
            .\rclone.exe ls "onedrive:$remotePath"
          } else {
            Write-Host "âŒ ä¸Šä¼ å¤±è´¥ï¼Œé”™è¯¯ä»£ç : $LASTEXITCODE"
            exit 1
          }
        } catch {
          Write-Host "âŒ ä¸Šä¼ å‡ºé”™: $_"
          exit 1
        }
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: DHI-EXE-v3.3-${{ github.run_number }}
        path: upload_package/
        retention-days: 30
    
    - name: Create release summary
      if: success()
      run: |
        Write-Host "ğŸ‰ æ„å»ºå®Œæˆæ‘˜è¦"
        Write-Host "===================="
        Write-Host "ğŸ“¦ ç‰ˆæœ¬: v3.3"
        Write-Host "ğŸ”¨ æ„å»ºæ—¶é—´: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
        $timestamp = Get-Date -Format 'yyyyMMdd_HHmmss'
        Write-Host "ğŸ“‚ OneDriveè·¯å¾„: DHI_Screening_System/releases/v3.3_$timestamp"
        Write-Host "ğŸ’¾ å¤‡ç”¨ä¸‹è½½: GitHub Actions Artifacts"
        Write-Host "ğŸ–¥ï¸ æ”¯æŒç³»ç»Ÿ: Windows 7/8/10/11 (32ä½/64ä½)"
        Write-Host "ğŸ“‹ ä½¿ç”¨è¯´æ˜: å‚è€ƒupload_packageä¸­çš„version_info.txt"
