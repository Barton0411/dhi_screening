name: Build Windows EXE (Multi-Architecture)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-windows-exe:
    runs-on: windows-latest
    strategy:
      matrix:
        architecture: [x64, x86]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        architecture: ${{ matrix.architecture }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install -r requirements.txt
    
    - name: Create architecture-specific spec file
      run: |
        $arch = "${{ matrix.architecture }}"
        $specContent = Get-Content "DHI_Screening_System_v3.0.spec" -Raw
        $specContent = $specContent -replace "APP_NAME = 'DHI_Screening_System_v3.0'", "APP_NAME = 'DHI_Screening_System_v3.0_$arch'"
        $specContent = $specContent -replace "target_arch=None", "target_arch='$arch'"
        $specContent | Out-File "DHI_Screening_System_v3.0_$arch.spec" -Encoding UTF8
        
    - name: Build EXE with PyInstaller
      run: |
        $arch = "${{ matrix.architecture }}"
        pyinstaller --clean --noconfirm "DHI_Screening_System_v3.0_$arch.spec"
    
    - name: Upload Architecture-specific Build
      uses: actions/upload-artifact@v4
      with:
        name: DHI_Screening_System_v3.0_${{ matrix.architecture }}
        path: dist/DHI_Screening_System_v3.0_${{ matrix.architecture }}/

  create-universal-installer:
    needs: build-windows-exe
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download x64 Build
      uses: actions/download-artifact@v4
      with:
        name: DHI_Screening_System_v3.0_x64
        path: dist/x64/
        
    - name: Download x86 Build  
      uses: actions/download-artifact@v4
      with:
        name: DHI_Screening_System_v3.0_x86
        path: dist/x86/
    
    - name: Install Inno Setup
      run: |
        $url = "https://files.jrsoftware.org/is/6/innosetup-6.2.2.exe"
        $output = "innosetup-installer.exe"
        Invoke-WebRequest -Uri $url -OutFile $output
        Start-Process -FilePath $output -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART" -Wait
        $env:PATH += ";C:\Program Files (x86)\Inno Setup 6"
        echo "C:\Program Files (x86)\Inno Setup 6" >> $env:GITHUB_PATH
        
    - name: Create Universal Installer Script
      run: |
        # åˆ›å»ºé€šç”¨å®‰è£…è„šæœ¬
        Write-Host "åˆ›å»ºé€šç”¨å®‰è£…è„šæœ¬..."
        
        # å…ˆåˆ›å»ºè„šæœ¬å¤´éƒ¨
        "; DHI Screening Analysis System v3.0 - Universal Installer" | Out-File "DHI_Universal_Setup.iss" -Encoding UTF8
        "; Supports both x86 and x64 architectures" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "#define MyAppNameChinese `"DHIç­›æŸ¥åˆ†æç³»ç»Ÿ`"" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "#define MyAppVersion `"3.0`"" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "#define MyAppPublisher `"Yili Liquid Milk Research Institute`"" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "[Setup]" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "AppId={{B6F5E7D4-8A2C-4F1B-9E3D-7A6C8B9D0E1F}" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "AppName={#MyAppNameChinese}" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "AppVersion={#MyAppVersion}" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "AppVerName={#MyAppNameChinese} v{#MyAppVersion}" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "AppPublisher={#MyAppPublisher}" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "DefaultDirName={autopf}\{#MyAppNameChinese}" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "DefaultGroupName={#MyAppNameChinese}" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "AllowNoIcons=yes" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "LicenseFile=LICENSE.txt" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "OutputDir=installer" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "OutputBaseFilename=DHI_Screening_System_v{#MyAppVersion}_Universal_Setup" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "SetupIconFile=whg3r-qi1nv-001.ico" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "Compression=lzma" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "SolidCompression=yes" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "WizardStyle=modern" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "MinVersion=6.1" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "ArchitecturesAllowed=x86 x64" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "ArchitecturesInstallIn64BitMode=x64" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "PrivilegesRequired=admin" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "[Languages]" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "Name: `"english`"; MessagesFile: `"compiler:Default.isl`"" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "[Tasks]" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "Name: `"desktopicon`"; Description: `"{cm:CreateDesktopIcon}`"; GroupDescription: `"{cm:AdditionalIcons}`"; Flags: unchecked" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "[Files]" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "Source: `"dist\x64\*`"; DestDir: `"{app}`"; Flags: ignoreversion recursesubdirs createallsubdirs; Check: Is64BitInstallMode" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "Source: `"dist\x86\*`"; DestDir: `"{app}`"; Flags: ignoreversion recursesubdirs createallsubdirs; Check: not Is64BitInstallMode" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "Source: `"README.md`"; DestDir: `"{app}`"; Flags: ignoreversion" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "Source: `"LICENSE.txt`"; DestDir: `"{app}`"; Flags: ignoreversion" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "Source: `"whg3r-qi1nv-001.ico`"; DestDir: `"{app}`"; Flags: ignoreversion" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "[Icons]" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "Name: `"{group}\{#MyAppNameChinese}`"; Filename: `"{app}\DHI_Screening_System_v3.0_x64.exe`"; Check: Is64BitInstallMode" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "Name: `"{group}\{#MyAppNameChinese}`"; Filename: `"{app}\DHI_Screening_System_v3.0_x86.exe`"; Check: not Is64BitInstallMode" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "Name: `"{autodesktop}\{#MyAppNameChinese}`"; Filename: `"{app}\DHI_Screening_System_v3.0_x64.exe`"; Tasks: desktopicon; Check: Is64BitInstallMode" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "Name: `"{autodesktop}\{#MyAppNameChinese}`"; Filename: `"{app}\DHI_Screening_System_v3.0_x86.exe`"; Tasks: desktopicon; Check: not Is64BitInstallMode" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "[Run]" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "Filename: `"{app}\DHI_Screening_System_v3.0_x64.exe`"; Flags: nowait postinstall skipifsilent; Check: Is64BitInstallMode" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        "Filename: `"{app}\DHI_Screening_System_v3.0_x86.exe`"; Flags: nowait postinstall skipifsilent; Check: not Is64BitInstallMode" | Add-Content "DHI_Universal_Setup.iss" -Encoding UTF8
        
        Write-Host "âœ… é€šç”¨å®‰è£…è„šæœ¬åˆ›å»ºå®Œæˆ"
        
    - name: Create Universal Installer
      run: |
        # åˆ›å»ºinstallerç›®å½•
        if (-not (Test-Path "installer")) {
          New-Item -ItemType Directory -Path "installer"
        }
        
        # ç¼–è¯‘é€šç”¨å®‰è£…è„šæœ¬
        $isccPath = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
        Write-Host "åˆ›å»ºé€šç”¨å®‰è£…åŒ…..."
        & $isccPath "DHI_Universal_Setup.iss"
        
        if ($LASTEXITCODE -eq 0) {
          Write-Host "âœ… é€šç”¨å®‰è£…åŒ…åˆ›å»ºæˆåŠŸ"
          $installerPath = "installer\DHI_Screening_System_v3.0_Universal_Setup.exe"
          if (Test-Path $installerPath) {
            $fileSize = (Get-Item $installerPath).Length / 1MB
            Write-Host "ğŸ“¦ å®‰è£…åŒ…å¤§å°: $([math]::Round($fileSize, 2)) MB"
          }
        } else {
          Write-Host "âŒ é€šç”¨å®‰è£…åŒ…åˆ›å»ºå¤±è´¥"
          exit 1
        }
        
    - name: Create Portable Versions
      run: |
        # åˆ›å»ºä¾¿æºç‰ˆæœ¬ç›®å½•
        mkdir -p release/portable_x64
        mkdir -p release/portable_x86
        
        # å¤åˆ¶x64ä¾¿æºç‰ˆ
        xcopy "dist\x64" "release\portable_x64\DHI_Screening_System_v3.0" /E /I
        xcopy "README.md" "release\portable_x64\" /Y
        xcopy "LICENSE.txt" "release\portable_x64\" /Y
        
        # å¤åˆ¶x86ä¾¿æºç‰ˆ  
        xcopy "dist\x86" "release\portable_x86\DHI_Screening_System_v3.0" /E /I
        xcopy "README.md" "release\portable_x86\" /Y
        xcopy "LICENSE.txt" "release\portable_x86\" /Y
        
        # å‹ç¼©ä¾¿æºç‰ˆ
        powershell Compress-Archive -Path "release\portable_x64\*" -DestinationPath "DHI_Screening_System_v3.0_Portable_x64.zip"
        powershell Compress-Archive -Path "release\portable_x86\*" -DestinationPath "DHI_Screening_System_v3.0_Portable_x86.zip"
        
    - name: Upload Universal Installer
      uses: actions/upload-artifact@v4
      with:
        name: DHI_Universal_Installer
        path: installer/
        
    - name: Upload Portable x64
      uses: actions/upload-artifact@v4
      with:
        name: DHI_Portable_x64
        path: DHI_Screening_System_v3.0_Portable_x64.zip
        
    - name: Upload Portable x86
      uses: actions/upload-artifact@v4
      with:
        name: DHI_Portable_x86
        path: DHI_Screening_System_v3.0_Portable_x86.zip
        
    - name: Create release info
      run: |
        $content = "# DHIç­›æŸ¥åˆ†æç³»ç»Ÿ v3.0 - å¤šæ¶æ„æ„å»º`n`n"
        $content += "## ğŸ¢ å¼€å‘å•ä½`nä¼Šåˆ©æ¶²å¥¶å¥¶ç§‘é™¢`n`n"
        $content += "## ğŸ“¦ æ„å»ºäº§ç‰©`n`n"
        $content += "### 1. é€šç”¨å®‰è£…åŒ…ï¼ˆæ¨èï¼‰`n"
        $content += "**æ–‡ä»¶**: DHI_Screening_System_v3.0_Universal_Setup.exe`n"
        $content += "- ğŸ”§ è‡ªåŠ¨æ£€æµ‹ç³»ç»Ÿæ¶æ„ï¼ˆx86/x64ï¼‰`n"
        $content += "- ğŸ“‹ æ”¯æŒWindows 7åŠä»¥ä¸Šç³»ç»Ÿ`n"
        $content += "- ğŸ¯ æ™ºèƒ½å®‰è£…å¯¹åº”æ¶æ„çš„ç¨‹åº`n"
        $content += "- âœ… å¼€å§‹èœå•å’Œæ¡Œé¢å¿«æ·æ–¹å¼`n"
        $content += "- ğŸ—‘ï¸ å®Œæ•´å¸è½½åŠŸèƒ½`n`n"
        $content += "### 2. ä¾¿æºç‰ˆæœ¬`n"
        $content += "**x64ç‰ˆæœ¬**: DHI_Screening_System_v3.0_Portable_x64.zip`n"
        $content += "**x86ç‰ˆæœ¬**: DHI_Screening_System_v3.0_Portable_x86.zip`n"
        $content += "- ğŸ’š å…å®‰è£…ç»¿è‰²ç‰ˆæœ¬`n"
        $content += "- ğŸ“‚ è§£å‹å³ç”¨`n"
        $content += "- ğŸ”“ æ— éœ€ç®¡ç†å‘˜æƒé™`n`n"
        $content += "## ğŸ–¥ï¸ ç³»ç»Ÿå…¼å®¹æ€§`n"
        $content += "- **æ”¯æŒç³»ç»Ÿ**: Windows 7, 8, 8.1, 10, 11`n"
        $content += "- **æ”¯æŒæ¶æ„**: x86 (32ä½) å’Œ x64 (64ä½)`n"
        $content += "- **å†…å­˜è¦æ±‚**: æœ€ä½2GB, æ¨è4GB+`n"
        $content += "- **ç£ç›˜ç©ºé—´**: 500MBå¯ç”¨ç©ºé—´`n`n"
        $content += "## ğŸš€ å®‰è£…è¯´æ˜`n`n"
        $content += "### é€šç”¨å®‰è£…åŒ…ï¼ˆæ¨èï¼‰`n"
        $content += "1. ä¸‹è½½ DHI_Screening_System_v3.0_Universal_Setup.exe`n"
        $content += "2. ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ`n"
        $content += "3. å®‰è£…ç¨‹åºä¼šè‡ªåŠ¨æ£€æµ‹æ‚¨çš„ç³»ç»Ÿæ¶æ„`n"
        $content += "4. è·Ÿéšå®‰è£…å‘å¯¼å®Œæˆå®‰è£…`n`n"
        $content += "### ä¾¿æºç‰ˆæœ¬`n"
        $content += "1. æ ¹æ®æ‚¨çš„ç³»ç»Ÿé€‰æ‹©å¯¹åº”çš„zipæ–‡ä»¶ï¼š`n"
        $content += "   - 64ä½ç³»ç»Ÿï¼šä¸‹è½½x64ç‰ˆæœ¬`n"
        $content += "   - 32ä½ç³»ç»Ÿï¼šä¸‹è½½x86ç‰ˆæœ¬`n"
        $content += "2. è§£å‹åˆ°ä»»æ„ç›®å½•`n"
        $content += "3. è¿è¡Œå¯¹åº”çš„exeæ–‡ä»¶`n`n"
        $content += "## ğŸ” å¦‚ä½•ç¡®å®šç³»ç»Ÿæ¶æ„`n"
        $content += "- æŒ‰Win+Rï¼Œè¾“å…¥msinfo32ï¼ŒæŸ¥çœ‹'ç³»ç»Ÿç±»å‹'`n"
        $content += "- æˆ–å³é”®'æ­¤ç”µè„‘' â†’ å±æ€§ â†’ æŸ¥çœ‹'ç³»ç»Ÿç±»å‹'`n`n"
        $content += "æ„å»ºæ—¶é—´: $(Get-Date)`n"
        $content += "æ„å»ºç‰ˆæœ¬: GitHub Actions å¤šæ¶æ„è‡ªåŠ¨æ„å»º"
        
        $content | Out-File -FilePath "æ„å»ºè¯´æ˜.txt" -Encoding UTF8
        
    - name: Upload Build Info
      uses: actions/upload-artifact@v4
      with:
        name: Build_Info_Universal
        path: æ„å»ºè¯´æ˜.txt 