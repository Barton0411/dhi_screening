name: Build Windows EXE and Installer

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # 允许手动触发

jobs:
  build-windows-exe:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install -r requirements.txt
    
    - name: Build EXE with PyInstaller
      run: |
        pyinstaller --clean --noconfirm "DHI_Screening_System_v3.0.spec"
    
    - name: Install Inno Setup
      run: |
        # 下载并安装Inno Setup
        $url = "https://jrsoftware.org/download.php/is.exe"
        $output = "innosetup-installer.exe"
        Invoke-WebRequest -Uri "https://files.jrsoftware.org/is/6/innosetup-6.2.2.exe" -OutFile $output
        Start-Process -FilePath $output -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART" -Wait
        # 添加Inno Setup到PATH
        $env:PATH += ";C:\Program Files (x86)\Inno Setup 6"
        echo "C:\Program Files (x86)\Inno Setup 6" >> $env:GITHUB_PATH
        
    - name: Verify Inno Setup installation
      run: |
        $innoPath = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
        if (Test-Path $innoPath) {
          Write-Host "✅ Inno Setup安装成功"
          Write-Host "ISCC.exe路径: $innoPath"
        } else {
          Write-Host "❌ Inno Setup安装失败"
          exit 1
        }
        
    - name: Check required files
      run: |
        Write-Host "检查必要文件是否存在:"
        $requiredFiles = @(
          "DHI_Screening_System_v3.0_Setup.iss",
          "LICENSE.txt", 
          "whg3r-qi1nv-001.ico",
          "README.md",
          "DHI_精准筛查助手-操作说明.md",
          "需求说明.md",
          "config.yaml",
          "rules.yaml"
        )
        
        foreach ($file in $requiredFiles) {
          if (Test-Path $file) {
            Write-Host "✅ $file 存在"
          } else {
            Write-Host "❌ $file 不存在"
          }
        }
        
        Write-Host "`n检查PyInstaller输出目录:"
        if (Test-Path "dist\DHI_Screening_System_v3.0") {
          Write-Host "✅ dist\DHI_Screening_System_v3.0 存在"
          $fileCount = (Get-ChildItem "dist\DHI_Screening_System_v3.0" -Recurse).Count
          Write-Host "   包含 $fileCount 个文件"
        } else {
          Write-Host "❌ dist\DHI_Screening_System_v3.0 不存在"
          exit 1
        }
        
    - name: Create installer with Inno Setup
      run: |
        # 创建installer目录
        if (-not (Test-Path "installer")) {
          New-Item -ItemType Directory -Path "installer"
        }
        # 编译安装脚本
        $isccPath = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
        Write-Host "开始编译安装脚本..."
        Write-Host "脚本文件: DHI_Screening_System_v3.0_Setup.iss"
        Write-Host "工作目录: $(Get-Location)"
        & $isccPath "DHI_Screening_System_v3.0_Setup.iss"
        if ($LASTEXITCODE -eq 0) {
          Write-Host "✅ 安装脚本编译成功"
        } else {
          Write-Host "❌ 安装脚本编译失败，退出代码: $LASTEXITCODE"
          exit 1
        }
        
    - name: Verify installer creation
      run: |
        $installerPath = "installer\DHI_Screening_System_v3.0_Setup.exe"
        if (Test-Path $installerPath) {
          $fileSize = (Get-Item $installerPath).Length / 1MB
          Write-Host "✅ 安装包生成成功: $([math]::Round($fileSize, 2)) MB"
          Write-Host "📁 安装包路径: $installerPath"
        } else {
          Write-Host "❌ 安装包生成失败"
          Write-Host "📁 installer目录内容:"
          Get-ChildItem installer -ErrorAction SilentlyContinue
          exit 1
        }
    
    - name: Create release package (Portable)
      run: |
        mkdir release
        xcopy "dist\DHI_Screening_System_v3.0" "release\DHI_Screening_System_v3.0" /E /I
        xcopy "README.md" "release\" /Y
        xcopy "DHI_精准筛查助手-操作说明.md" "release\" /Y
        xcopy "LICENSE.txt" "release\" /Y
        
    - name: Upload Portable Version
      uses: actions/upload-artifact@v4
      with:
        name: DHI_Screening_System_v3.0_Portable
        path: release/
        
    - name: Upload Windows Installer
      uses: actions/upload-artifact@v4
      with:
        name: DHI_Screening_System_v3.0_Installer
        path: installer/
        
    - name: Compress portable for release
      run: |
        powershell Compress-Archive -Path "release\*" -DestinationPath "DHI_Screening_System_v3.0_Portable.zip"
        
    - name: Upload Portable ZIP
      uses: actions/upload-artifact@v4
      with:
        name: DHI_Screening_System_v3.0_Portable_ZIP
        path: DHI_Screening_System_v3.0_Portable.zip
        
    - name: Create release info
      run: |
        $content = "# DHI筛查分析系统 v3.0 构建信息`n`n"
        $content += "## 开发单位`n伊利液奶奶科院`n`n"
        $content += "## 构建产物`n"
        $content += "1. 安装包版本: DHI_Screening_System_v3.0_Setup.exe`n"
        $content += "   - 专业Windows安装程序`n"
        $content += "   - 支持开始菜单、桌面快捷方式`n"
        $content += "   - 包含完整的卸载功能`n"
        $content += "   - 推荐用于生产环境`n`n"
        $content += "2. 便携版本: DHI_Screening_System_v3.0_Portable.zip`n"
        $content += "   - 免安装绿色版本`n"
        $content += "   - 解压即用，无需管理员权限`n"
        $content += "   - 适合临时使用或测试`n`n"
        $content += "## 系统要求`n"
        $content += "- Windows 10 或更高版本 (64位)`n"
        $content += "- 4GB RAM (推荐8GB)`n"
        $content += "- 500MB 可用磁盘空间`n`n"
        $content += "## 主要功能`n"
        $content += "- DHI数据筛选分析`n"
        $content += "- 隐形乳房炎监测`n"
        $content += "- 慢性乳房炎筛查`n"
        $content += "- 牛群健康管理`n`n"
        $content += "## 安装说明`n"
        $content += "### 安装包版本`n"
        $content += "1. 下载 DHI_Screening_System_v3.0_Setup.exe`n"
        $content += "2. 以管理员身份运行安装程序`n"
        $content += "3. 按照安装向导完成安装`n"
        $content += "4. 从开始菜单启动程序`n`n"
        $content += "### 便携版本`n"
        $content += "1. 下载 DHI_Screening_System_v3.0_Portable.zip`n"
        $content += "2. 解压到任意目录`n"
        $content += "3. 运行 DHI_Screening_System_v3.0.exe`n`n"
        $content += "构建时间: $(Get-Date)`n"
        $content += "构建版本: GitHub Actions 自动构建"
        $content | Out-File -FilePath "构建说明.txt" -Encoding UTF8
        
    - name: Upload release info
      uses: actions/upload-artifact@v4
      with:
        name: Build_Info
        path: 构建说明.txt 